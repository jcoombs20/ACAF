<!DOCTYPE html>
<html>
  <head>
    <title>Massachusetts Avian Community Assemblage Forecaster Tool</title>
    <link rel="icon" type="image/png" href="images/bird-favicon.ico">

    <!--link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css"/-->
    <link rel="stylesheet" href="styles/bootstrap.min.css"/>
    <!--link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intro.js/2.4.0/introjs.min.css"/-->
    <link rel="stylesheet" href="introjs.min.css"/>
    <!--link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css"/-->
    <link rel="stylesheet" href="leaflet.css"/>
    <!--link rel="stylesheet" href="http://colorbrewer2.org/export/colorbrewer.css"/-->
    <link rel="stylesheet" href="colorbrewer.css"/>
    <link rel="stylesheet" href="styles/Control.BingGeocoder.css"/>
    <link rel="stylesheet" href="styles/Control.maxExtent.css"/>
    <link rel="stylesheet" href="leaflet-draw-old/dist/leaflet.draw.css"/>
    <link rel="stylesheet" href="leaflet.measurecontrol/leaflet.measurecontrol.css"/>
    <link rel="stylesheet" href="styles/Control.mousePosition.css"/>
    <!--link rel="stylesheet" href="styles/Control.downLoadFile.css"/-->
    <link rel="stylesheet" href="styles/Control.print.css"/>
    <link rel="stylesheet" href="styles/birds.css"/>

    <!--script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script-->
    <script src="leaflet.js"></script>
    <!--script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script-->
    <script src="jquery-3.2.1.min.js"></script>
    <script src="jquery-ui.min.js"></script>
    <!--script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script-->
    <script src="bootstrap.min.js"></script>
    <script src="http://maps.google.com/maps/api/js?v=3"></script>
    <script src="bundle.js"></script>
    <script src="Bing_tile.js"></script>
    <script src="Google_tile.js"></script>
    <script src="Control.BingGeocoder.js"></script>
    <script src="Control.maxExtent.js"></script>
    <script src="leaflet-draw-old/dist/leaflet.draw.js"></script>
    <script src="leaflet.measurecontrol/leaflet.measurecontrol.js"></script>
    <script src="Control.mousePosition.js"></script>
    <script src="Control.downLoadFile.js"></script>
    <script src="Control.print.js"></script>

    <!--script src="http://d3js.org/d3.v3.min.js"></script-->
    <script src="d3.v3.min.js"></script>
    <!--script src="http://d3js.org/topojson.v1.min.js"></script-->
    <script src="topojson.v1.min.js"></script>
    <!--script src="http://colorbrewer2.org/export/colorbrewer.js"></script-->
    <script src="colorbrewer.js"></script>
    <!--script src="https://cdnjs.cloudflare.com/ajax/libs/queue-async/1.0.7/queue.min.js"></script-->
    <script src="queue.min.js"></script>
    <script src="crossfilter.min.js"></script>

  </head>

  <body>
    <div id="map"></div>

    <script type='text/javascript'>
      //******Initialize bootstrap tooltip
      $(document).ready(function(){
        $('[data-toggle="tooltip"]').tooltip();   
      });

      //******Call funtion to reposition windows on resize
      window.addEventListener('resize', resizePanels);

      function resizePanels() {
        var bodyRect = document.body.getBoundingClientRect();
        var tmpWindows = ["legendDiv", "drawDiv", "songsDiv", "downloadDiv"];
        
        tmpWindows.forEach(function(win) {
          var winRect = document.getElementById(win).getBoundingClientRect();
          if(winRect.bottom > bodyRect.bottom) {
            d3.select("#" + win).style("top", bodyRect.height - winRect.height + "px");
          }
          if(winRect.right > bodyRect.right) {
            d3.select("#" + win).style("left", bodyRect.width - winRect.width + "px");
          }
        });
      }


      //******Add Map
      var map = new L.Map('map', {center: new L.LatLng(42.2, -72.03), zoomControl: false, zoom: 9, minZoom: 2, maxZoom: 20, inertiaDeceleration: 1000});

      //geoJSON holding variable
      var tmpGeo;

      //******Add map controls
      L.control.scale({ maxWidth: 200 }).addTo(map);
      L.control.mousePosition().addTo(map);
      L.control.zoom({ position: 'bottomright', zoomInTitle: "Zoom in (can also be done with mouse wheel, double-click, '+' key, or by pressing the 'shift' key while clicking and dragging a rectangle)", zoomOutTitle: "Zoom out (can also be done with the mouse wheel or the '-' key)" }).addTo(map);
      L.control.maxExtent().addTo(map);

      //******Add draw controls
      var drawnItems = new L.FeatureGroup();
      map.addLayer(drawnItems);

      var drawControl = new L.Control.Draw({
      	draw: {
          position: 'topleft',
          polygon: {allowIntersection: false, drawError: {color: '#b00b00', timeout: 1500}, shapeOptions: {color: '#ff33cc'}, showArea: true},
          rectangle: {shapeOptions: {color: '#ff33cc'}, showArea: true},
          circle: {shapeOptions: {color: '#ff33cc'}, showArea: true},
          polyline: false,
          marker: false
      	},
      	edit: {
          featureGroup: drawnItems,
          edit: {selectedPathOptions: {maintainColor: true, opacity: 1, fillOpacity: 0.2}},
          poly: {allowIntersection: false, drawError: {color: '#b00b00', timout: 1500}}
      	}
      });

      map.on('draw:created', function (e) {
        getShape(e.layerType, e.layer); 
        e.layer.on("edit", updateShape);       
      	drawnItems.addLayer(e.layer);
        drawnItems._layers[L.stamp(e.layer)]["layerType"] = e.layerType;
        tmpGeo = e.layer.toGeoJSON();
        d3.select(".leaflet-draw-section").style("pointer-events", "none").style("opacity", "0.4");
        //toolWindowToggle("draw");
      });

      map.on('draw:deleted', function (e) {
        d3.select(".leaflet-draw-section").style("pointer-events", "auto").style("opacity", "1");
        d3.select(".leaflet-draw-section").style("opacity", "1");
        d3.select("#edgeText").attr("value", "");
        d3.select("#areaText").attr("value", "");
        //d3.select("#shapeDiv").style("display", "none");
      });

      map.on('draw:editmove', function (e) {
        getShape(e.layer.layerType, e.layer);        
      });

      map.on('draw:editresize', function (e) {
        getShape(e.layer.layerType, e.layer);        
      });

      map.on('draw:editvertex', function (e) {
        getShape(e.layer.layerType, e.layer);        
      });

      function updateShape(e) {
        getShape(e.target.layerType, e.target);
      }

      //******Add ability to measure polygon perimeter
      L.Polyline.include({
        length: function () {
          var latlngs = this.getLatLngs();
          var length = 0;
          for (var i = 0, n = latlngs.length - 1; i< n; i++) {
            length += latlngs[i].distanceTo(latlngs[i+1]);
          }
          return length;
        }
      });

      L.Polygon.include({
        perimeter: function () {
          var length = L.Polyline.prototype.length.call(this);
          var latlngs = this.getLatLngs();
          if (latlngs.length > 2) {
            length += latlngs[0].distanceTo(latlngs[latlngs.length - 1]);
          }
          return length;
        }
      });

      L.Circle.include({
        circumference: function () {
          var radius = this.getRadius();
          var length = 2 * Math.PI * radius;
          return length
        }
      });

      L.Circle.include({
        area: function () {
          var radius = this.getRadius();
          var length = Math.PI * (radius * radius);
          return length
        }
      });

      function getShape(type, layer) {
        switch (type) {
          case 'polygon':
            var length = layer.perimeter();
            var area = L.GeometryUtil.geodesicArea(layer.getLatLngs());
            break;
          case 'rectangle':
            var length = layer.perimeter();
            var area = L.GeometryUtil.geodesicArea(layer.getLatLngs());
            break;
          case 'circle':
            var length = layer.circumference();
            var area = layer.area();
            break;
          case 'marker':
            layer.bindPopup(e.layer._latlng.lat.toFixed(3) + ", " + e.layer._latlng.lng.toFixed(3));
            break;
          case 'draw:editresize':
            var length = layer.perimeter();
            var area = L.GeometryUtil.geodesicArea(layer.getLatLngs());
            break;            
        }      
        changeUnits("Meters", d3.select("#edgeUnit").property("value"), length, "edge");
        changeUnits("Square Meters", d3.select("#areaUnit").property("value"), area, "area");
      }


      //***Bing geocoder control
      var tmpPoint = new L.marker;
      var bingGeocoder = new L.Control.BingGeocoder('At3gymJqaoGjGje-JJ-R5tJOuilUk-gd7SQ0DBZlTXTsRoMfVWU08ZWF1X7QKRRn', { callback: function (results) {
        if(results.statusCode == 200) {
          if(d3.select("#bingGeocoderSubmit").classed("glyphicon-search")) {
            $(document).ready(function(){
              $('[data-toggle="tooltip"]').tooltip();   
            });
            document.getElementById("bingGeocoderInput").blur();
            var bbox = results.resourceSets[0].resources[0].bbox,
              first = new L.LatLng(bbox[0], bbox[1]),
              second = new L.LatLng(bbox[2], bbox[3]),
              tmpBounds = new L.LatLngBounds([first, second]);
            this._map.fitBounds(tmpBounds);
            this._map.removeLayer(tmpPoint);
            tmpPoint = new L.marker(results.resourceSets[0].resources[0].point.coordinates);  //.bindPopup(results.resourceSets[0].resources[0].address.formattedAddress);
            this._map.addLayer(tmpPoint);
            d3.select(".leaflet-marker-icon")
              .attr("id","mapIcon")
              .attr("data-toggle", "tooltip")
              .attr("data-container", "body")
              .attr("data-placement", "auto top")
              .attr("data-html", "true")
              .attr("title", '<p><b><center>' + results.resourceSets[0].resources[0].name + '</center></b></p>');
            d3.select(tmpPoint)
              .on("click", function() { clearSearch(); });
            d3.select("#bingGeocoderSubmit")
              .classed("glyphicon-search", false)
              .classed("glyphicon-remove", true)
              .style({"background":"#ff0040", "background":"linear-gradient(#ff0040, #b3002d)", "color":"#990000"})
              .property("title", "Click to clear search results");
          }
          else {
            clearSearch();
          }
        }
        }
      });

      //******Clear the results of the geo search
      function clearSearch() {
        map.removeLayer(tmpPoint);
        d3.select(".tooltip").remove();
        d3.select("#bingGeocoderInput").property("value", "");

        d3.select("#bingGeocoderSubmit")
          .classed("glyphicon-remove", false)
          .classed("glyphicon-search", true)
          .style({"background":"", "color":""})
          .property("title", "Click to zoom to specified location");
      }



      //******Add base layers
      var googleHybrid = L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}',{
        maxZoom: 20,
        subdomains:['mt0','mt1','mt2','mt3']
      });
      var googleSatellite = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{
        maxZoom: 20,
        subdomains:['mt0','mt1','mt2','mt3']
      }); 
      var googleStreet = L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{
        maxZoom: 20,
        subdomains:['mt0','mt1','mt2','mt3']
      });
      var googleTerrain = googleTerrain = L.tileLayer('http://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}',{
        maxZoom: 20,
        subdomains:['mt0','mt1','mt2','mt3']
      });

      var bingHybrid = new L.BingLayer("At3gymJqaoGjGje-JJ-R5tJOuilUk-gd7SQ0DBZlTXTsRoMfVWU08ZWF1X7QKRRn", {type: 'AerialWithLabels'});
      var bingSatellite = new L.BingLayer("At3gymJqaoGjGje-JJ-R5tJOuilUk-gd7SQ0DBZlTXTsRoMfVWU08ZWF1X7QKRRn", {type: 'Aerial'});
      var bingStreet = new L.BingLayer("At3gymJqaoGjGje-JJ-R5tJOuilUk-gd7SQ0DBZlTXTsRoMfVWU08ZWF1X7QKRRn", {type: 'Road'});
      var usgsTopo = new L.tileLayer('http://basemap.nationalmap.gov/ArcGIS/rest/services/USGSTopo/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 15,
            zIndex: 0,
            attribution: '<a href="http://www.doi.gov">U.S. Department of the Interior</a> | <a href="http://www.usgs.gov">U.S. Geological Survey</a> | <a href="http://www.usgs.gov/laws/policies_notices.html">Policies</a>'
            });
      var states = new L.tileLayer.wms("http://felek.cns.umass.edu:8080/geoserver/CL/wms", {
          layers: 'us_states',
          format: 'image/png',
          transparent: true,
          version: '1.1.0',
          maxZoom: 20,
        });
      var blank = new L.tileLayer('');
    
      map.addLayer(googleHybrid);

      //******Add Geoserver Layers
      var baww = L.tileLayer.wms("http://felek.cns.umass.edu:8080/geoserver/birds/wms", {
        layers: 'birds:baww_wgs84',
        format: 'image/png',
        transparent: true,
        version: '1.1.0',
        maxZoom: 20
      });

      var coye = L.tileLayer.wms("http://felek.cns.umass.edu:8080/geoserver/birds/wms", {
        layers: 'birds:coye_wgs84',
        format: 'image/png',
        transparent: true,
        version: '1.1.0',
        maxZoom: 20
      });

      var cswa = L.tileLayer.wms("http://felek.cns.umass.edu:8080/geoserver/birds/wms", {
        layers: 'birds:cswa_wgs84',
        format: 'image/png',
        transparent: true,
        version: '1.1.0',
        maxZoom: 20
      });

      var eato = L.tileLayer.wms("http://felek.cns.umass.edu:8080/geoserver/birds/wms", {
        layers: 'birds:eato_wgs84',
        format: 'image/png',
        transparent: true,
        version: '1.1.0',
        maxZoom: 20
      });

      var grca = L.tileLayer.wms("http://felek.cns.umass.edu:8080/geoserver/birds/wms", {
        layers: 'birds:grca_wgs84',
        format: 'image/png',
        transparent: true,
        version: '1.1.0',
        maxZoom: 20
      });

      var inbu = L.tileLayer.wms("http://felek.cns.umass.edu:8080/geoserver/birds/wms", {
        layers: 'birds:inbu_wgs84',
        format: 'image/png',
        transparent: true,
        version: '1.1.0',
        maxZoom: 20
      });

      var praw = L.tileLayer.wms("http://felek.cns.umass.edu:8080/geoserver/birds/wms", {
        layers: 'birds:praw_wgs84',
        format: 'image/png',
        transparent: true,
        version: '1.1.0',
        maxZoom: 20
      });

      var gsTowns = L.tileLayer.wms("http://felek.cns.umass.edu:8080/geoserver/crossings/wms", {
        layers: 'crossings:deerfield_towns',
        format: 'image/png',
        transparent: true,
        version: '1.1.0',
        maxZoom: 20
      });

      var gsCounties = L.tileLayer.wms("http://felek.cns.umass.edu:8080/geoserver/crossings/wms", {
        layers: 'crossings:deerfield_counties',
        format: 'image/png',
        transparent: true,
        version: '1.1.0',
        maxZoom: 20
      });

      var gsDOTDistricts = L.tileLayer.wms("http://felek.cns.umass.edu:8080/geoserver/crossings/wms", {
        layers: 'crossings:deerfield_dot_districts',
        format: 'image/png',
        transparent: true,
        version: '1.1.0',
        maxZoom: 20
      });

      var gsHUC12 = L.tileLayer.wms("http://felek.cns.umass.edu:8080/geoserver/crossings/wms", {
        layers: 'crossings:deerfield_huc12',
        format: 'image/png',
        transparent: true,
        version: '1.1.0',
        maxZoom: 20
      });

      //******Make layer controller
      var baseLayers = {"Google Hybrid": googleHybrid, "Google Satellite": googleSatellite, "Google Street": googleStreet, "Google Terrain": googleTerrain, "Bing Hybrid": bingHybrid, "Bing Satellite": bingSatellite, "Bing Street": bingStreet, "USGS Topo": usgsTopo, "None": blank};
      var overlays = {"Black & White Warbler": baww, "Common Yellowthroat": coye, "Prairie Warbler": praw, "Counties": gsCounties, "Towns": gsTowns, "HUC 12 Watersheds": gsHUC12};
      //L.control.layers(baseLayers, overlays).addTo(map);

      d3.select(".leaflet-control-layers-base").property("title", "Click on radio button to change the baselayer option");
      d3.select(".leaflet-control-layers-overlays").property("title", "Check the box to add layer to map (may be slight delay)");

      //******Add Download tool
      var downLoadFile = new L.Control.downLoadFile();
      //map.addControl(downLoadFile);

      //******Add Print tool
      var printMap = new L.Control.print();
      //map.addControl(printMap);



      //******Make layer controller
      //***baselayers
      var layerNames = {};
      layerNames.baseLayers = {"Google Terrain": googleTerrain, "Google Hybrid": googleHybrid, "Google Satellite": googleSatellite, "Google Street": googleStreet, "Bing Hybrid": bingHybrid, "Bing Satellite": bingSatellite, "Bing Street": bingStreet, "USGS Topo": usgsTopo, "State Outlines": states, "None": blank};
      layerNames.baseLayers.keys = d3.keys(layerNames.baseLayers);
      layerNames.baseLayers.values = d3.values(layerNames.baseLayers);

      //***Bird layers
      var birdTitles = ["Black and White Warbler", "Chestnut Sided Warbler", "Common Yellowthroat", "Eastern Towhee", "Gray Catbird", "Indigo Bunting", "Prairie Warbler"];
      var birdLayers = [baww, cswa, coye, eato, grca, inbu, praw];
      var birdID = ["baww", "cswa", "coye", "eato", "grca", "inbu", "praw"];
      layerNames.birds = {};
      birdTitles.forEach(function(tmpTitle,i) {
        layerNames.birds[tmpTitle] = birdLayers[i];
      });
      layerNames.birds.keys = d3.keys(layerNames.birds);
      layerNames.birds.values = d3.values(layerNames.birds);




      //******Make header div
      d3.select("body")
        .append("div")
        .attr("class", "header")
        .html('<span class="brand">ACAF: Avian Community Assemblage Forecaster</span> <div id="headerLinks"><a title="Click to display information on how to use this tool" href="#" data-toggle="modal" data-target="#helpDiv">About ACAF</a><a title="Click to go to the Ecosheds homepage" href="http://ecosheds.org" target="_blank">SHEDS Home</a></div><div id="printDownload" class="pull-right"><span id="downloadControl" class="glyphicon glyphicon-download-alt" title="Download spatial data" onclick="toolWindowToggle(&quot;download&quot;)"></span><span id="printControl" class="glyphicon glyphicon-print" title="Print current map" onclick="window.print()"></span></div>');



      //******Make headerControls div
      d3.select("body")
        .append("div")
        .attr("id", "headerControls");



      //******Add toolbar tools
      //***Baselayers
      d3.select("#headerControls")
        .append("div")
        .attr("id", "mapTools")
        .append("div")
        .attr("id", "baselayerSelect")
        .attr("class", "layerList")
        .append("div")
        .attr("id", "baselayerList")
        .attr("class", "cl_select")
        .property("title", "Click to change map baselayer")
        .html('<span id="baselayerListHeader">Change Map Baselayer</span><span class="glyphicon glyphicon-triangle-bottom pull-right" style="position:relative;top:3px;"></span>')
        .on("click", function() { if(d3.select("#baselayerListDropdown").style("display") == "none") {d3.select("#baselayerListDropdown").style("display", "inline-block");} else {d3.select("#baselayerListDropdown").style("display", "none");} });;

      d3.select("#baselayerSelect")
        .append("div")
        .attr("id", "baselayerListDropdown")
        .attr("class", "layerListDropdown")
        .on("mouseleave", function() { d3.select(this).style("display", "none") });

      //******Add baselayer options
      d3.select("#baselayerListDropdown").selectAll("div")
        .data(layerNames.baseLayers.keys)
        .enter()
          .append("div")
          .attr("class", "layerName")
          .text(function(d) { return d; })
          .property("value", function(d,i) { return i; })
          .property("title", function(d) { return d; })
          .on("click", function() { changeBaselayer(this); })
          .append("span")
          .attr("class", "glyphicon glyphicon-ok pull-right activeOverlay")
          .style("visibility", function(d,i) { if(i == 0) {return "visible";} else {return "hidden";} });


      //******Initialize baselayer
      map.addLayer(googleTerrain);

      //******Function to change baselayer on select change
      function changeBaselayer(tmpDiv) {
        //***Remove old layer
        var layerDivs = d3.select("#baselayerListDropdown").selectAll("div");
        
        layerDivs[0].forEach(function(tmpLayer) {
          if(d3.select(tmpLayer).select("span").style("visibility") == "visible") {
            d3.select(tmpLayer).select("span").style("visibility", "hidden");
            map.removeLayer(layerNames.baseLayers.values[d3.select(tmpLayer).property("value")]);
          }
        });

        //***Add new layer
        d3.select(tmpDiv).select("span").style("visibility", "visible");
        map.addLayer(layerNames.baseLayers.values[tmpDiv.value]);
        layerNames.baseLayers.values[tmpDiv.value].bringToBack();       
      }






      //***Bird layers
      d3.select("#mapTools")
        .append("div")
        .attr("id", "birdSelect")
        .attr("class", "layerList")
        .append("div")
        .attr("id", "birdList")
        .attr("class", "cl_select")
        .property("title", "Click to select bird occupancy layers to display on map")
        .html('<span id="birdListHeader">View Bird Occupancy Map Layers</span><span class="glyphicon glyphicon-triangle-bottom pull-right" style="position:relative;top:3px;"></span>')
        .on("click", function() { if(d3.select("#birdListDropdown").style("display") == "none") {d3.select("#birdListDropdown").style("display", "inline-block");} else {d3.select("#birdListDropdown").style("display", "none");} });;

      d3.select("#birdSelect")
        .append("div")
        .attr("id", "birdListDropdown")
        .attr("class", "layerListDropdown")
        .on("mouseleave", function() { d3.select(this).style("display", "none") });

      //******Add bird options
      d3.select("#birdListDropdown").selectAll("div")
        .data(layerNames.birds.keys)
        .enter()
          .append("div")
          .attr("class", "layerName")
          .text(function(d) { return d; })
          .property("value", function(d,i) { return i; })
          .property("title", function(d) { return d; })
          .property("name", function(d,i) { return birdID[i]; })
          .on("click", function() { changeBird(this); })
          .append("span")
          .attr("class", "glyphicon glyphicon-ok pull-right activeBird")
          .style("visibility", function(d) { if(d == "Deerfield Watershed") {return "visible";} else {return "hidden";} });

      //******Add Geoserver Deerfield HUC8 layer to map
      //map.addLayer(gsHuc8);

      //******Function to add/remove bird layer
      function changeBird(tmpDiv) {
        if(d3.select(tmpDiv).select("span").style("visibility") == "hidden") {
          d3.select(tmpDiv).select("span").style("visibility", "visible");
          map.addLayer(layerNames.birds.values[tmpDiv.value]);
          layerNames.birds.values[tmpDiv.value].bringToFront();
          addLegendImg(tmpDiv.name + "_wgs84", tmpDiv.title, layerNames.birds.values[tmpDiv.value], ["birds",tmpDiv.title]);
        } 
        else {
          d3.select(tmpDiv).select("span").style("visibility", "hidden");
          map.removeLayer(layerNames.birds.values[tmpDiv.value]);
          remLegendImg(tmpDiv.name);
        }
      }





      //******Add geolocater
      d3.select("#headerControls")
        .append("div")
        .attr("id", "bingGeoLocate");
        //.attr("class", "layerList");

      document.getElementById('bingGeoLocate').appendChild(bingGeocoder.onAdd(map));






      //Add panel icons
      d3.select("#headerControls")
        .append("div")
        .attr("id", "panelTools");

      var hcPanels = ["draw", "songs"];
      var hcGlyphs = ["glyphicon-pencil", "glyphicon-music"];
      var hcLabel = ["Draw & Measure", "Bird Songs & Photos"]
      d3.select("#panelTools").selectAll("divs")
        .data(hcPanels)
        .enter()
          .append("div")
          .attr("id", function(d) { return "hc" + d.charAt(0).toUpperCase() + d.slice(1) + "Div"; })
          .attr("class", "hcPanelDivs layerList")
          .property("title", function(d,i) { return "Click to show " + hcLabel[i] + " window"; })
          .html(function(d,i) { return '<span class="glyphicon ' + hcGlyphs[i] + '"></span><p>' + hcLabel[i] + '</p>'; })
          .on("click", function(d) { if(d != "attrSelect") { return toolWindowToggle(d);} });






      //******Function to toggle tool windows
      var toggleWords = {"legend":"Layers", "draw":"Draw & Measure", "songs":"Bird Songs & Photos", "download":"Downloads"}

      function toolWindowToggle(tmpDiv) {
        if (d3.select("#" + tmpDiv + "Div").style("opacity") == "1") {
          d3.select("#" + tmpDiv + "Div").transition().style({"opacity":"0", "visibility":"hidden"});
          d3.select("#hc" + tmpDiv.charAt(0).toUpperCase() + tmpDiv.slice(1) + "Div").property("title", "Click to show " + toggleWords[tmpDiv] + " window");
          
        }
        else {
          d3.select("#" + tmpDiv + "Div").transition().duration(250).ease("cubic").style({"opacity":"1", "display":"block", "visibility":"visible"});            
          d3.select("#hc" + tmpDiv.charAt(0).toUpperCase() + tmpDiv.slice(1) + "Div").property("title", "Click to hide " + toggleWords[tmpDiv] + " window");
          setZ(d3.select("#" + tmpDiv + "Div")[0][0]);
        }
      }






      function setZ(tmpWin) {
        if (d3.select("#map").classed("introjs-showElement") == false) {
          d3.selectAll("#legendDiv,#drawDiv,#songsDiv,#downloadDiv").style("z-index", function() { if(d3.select(this).style("opacity") == 1) {return 1001;} else {return 7500;} }); 
          d3.select(tmpWin).style("z-index", 1002);
        }
      }





      //******Adds images to the legend
      var legendDivs = [];   //global array of active legends

      function addLegendImg(tmpName, tmpTitle, tmpLayer, tmpPath) {
        legendDivs.push(tmpName);
        d3.selectAll(".layerLegend").style("display", "none");

        d3.select("#legendImgDiv")
          .append("div")
          .attr("id", tmpName + "Legend")
          .attr("value", tmpPath)
          .attr("class", "layerLegend")
          .style("margin-top", "25px")
          .append("h3")
          .attr("class", "legendTitle")
          .text(tmpTitle);

        d3.select("#" + tmpName + "Legend")
          .append("img")
          .attr("class", "legendImg")
          .attr("src", "http://felek.cns.umass.edu:8080/geoserver/wms?REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&WIDTH=30&HEIGHT=30&LAYER=birds:" + tmpName)
          .property("title", tmpTitle);

        d3.select("#" + tmpName + "Legend")
          .append("input")
          .attr({type: "range", name: "layer", min: 0, max: 100, value: 100})
          .attr("id", "legendSlider")
          .property("title", tmpTitle + " Layer Opacity: 100%")
          .on("input", function() { layerOpacity(this, tmpLayer); });

        d3.select("#" + tmpName + "Legend")
          .append("p")
          .attr("class", "legendTrans")
          .text("Transparency");

        d3.select("#legendDefault").style("display", "none");

        d3.select("#legendImgDiv")
          .style("display", "block");
        
        if(legendDivs.length > 1) {
          d3.select("#legendPrev").style("visibility", "visible");
          d3.select("#legendNext").style("visibility", "hidden");
        }

        if(d3.select("#legendDiv").style("opacity") == 0) {
          toolWindowToggle("legend");
        }

        setTimeout(function() { resizePanels(); }, 300);
      }







      //******Removes images to the legend
      function remLegendImg(tmpName) {
        var tmpBi = 0;
        if(d3.select("#" + tmpName + "Legend").style("display") == "block") {
          tmpBi = 1;
        }

        d3.select("#" + tmpName + "Legend").remove();
        legendDivs.splice(legendDivs.indexOf(tmpName),1);

        if(tmpBi == 1 && legendDivs.length > 0) {
          d3.select("#" + legendDivs[0] + "Legend").style("display", "block");
          var keys = d3.select("#" + legendDivs[0] + "Legend").attr("value").split(",");
          if(keys.length == 2) {
            layerNames[keys[0]][keys[1]].bringToFront();
          }
          else {
            layerNames[keys[0]][keys[1]][keys[2]].bringToFront();
          }
        }

        if(legendDivs.length == 0) {
          d3.select("#legendImgDiv").style("display", "none");
          d3.select("#legendDefault").style("display", "block");
        }
        else if(tmpBi == 1) {
          if(legendDivs.length == 1) {
            d3.selectAll("#legendPrev,#legendNext").style("visibility", "hidden");
          }
          else {
            d3.select("#legendPrev").style("visibility", "hidden");
            d3.select("#legendNext").style("visibility", "visible");
          }
        }
      }





      //******Change current legend div
      function changeLegend(tmpDir) {
        var tmpBi = 0;
        legendDivs.some(function(tmpName,i) {
          if(d3.select("#" + tmpName + "Legend").style("display") == "block") {
            tmpBi = 1;
            d3.selectAll(".layerLegend").style("display", "none");
            if(tmpDir == "prev") {
              d3.select("#" + legendDivs[i-1] + "Legend").style("display", "block");
                var keys = d3.select("#" + legendDivs[i-1] + "Legend").attr("value").split(",");
                if(keys.length == 2) {
                  layerNames[keys[0]][keys[1]].bringToFront();
                }
                else {
                  layerNames[keys[0]][keys[1]][keys[2]].bringToFront();
                }
            }
            else {
              d3.select("#" + legendDivs[i+1] + "Legend").style("display", "block");
                var keys = d3.select("#" + legendDivs[i+1] + "Legend").attr("value").split(",");
                if(keys.length == 2) {
                  layerNames[keys[0]][keys[1]].bringToFront();
                }
                else {
                  layerNames[keys[0]][keys[1]][keys[2]].bringToFront();
                }
            }
          }
          return tmpBi == 1;
        });

        tmpBi = 0;
        legendDivs.some(function(tmpName,i) {
          if(d3.select("#" + tmpName + "Legend").style("display") == "block") {
            tmpBi = 1;
            if(i == 0) {
              d3.select("#legendPrev").style("visibility", "hidden");
              d3.select("#legendNext").style("visibility", "visible");
            }
            else if(i == (legendDivs.length - 1)) {
              d3.select("#legendPrev").style("visibility", "visible");
              d3.select("#legendNext").style("visibility", "hidden");
            }
            else {
              d3.select("#legendPrev").style("visibility", "visible");
              d3.select("#legendNext").style("visibility", "visible");
            }
          }
          return tmpBi == 1;
        });              
      }
        






      //******Make div for legend
      d3.select("body")
        .append("div")
        .attr("class", "legend gradDown")
        .attr("id", "legendDiv");

      $('#legendDiv').draggable({containment: "html", cancel: ".toggle-group,input,textarea,button,select,option"});

      d3.select("#legendDiv")
        .append("h4")
        .text("Legend")
        .attr("class", "legTitle")
        .attr("id", "legendTitle")
        .append("span")
        .html('<span class="glyphicon glyphicon-info-sign help-tooltip" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Legend</center></b></u></p><p>Displays legends for added map layers enabling their interpretation along with control over their transparency.</p>"</span>');
 
      d3.select("#legendTitle")
        .append("span")
        .attr("class", "glyphicon glyphicon-remove pull-right minimize-button")
        .property("title", "Click to hide Layers window")
        .on("click", function() { toolWindowToggle("legend"); });

      d3.select("#legendDiv")
        .append("div")
        .attr("id", "legendDefault")
        .text("Add a map layer to view its legend...");

      d3.select("#legendDiv")
        .append("div")
        .attr("id", "legendImgDiv")
        .html('<span id="legendPrev" class="glyphicon glyphicon-menu-left pull-left" title="View previous legend" onclick="changeLegend(\'prev\')"></span><span id="legendNext" class="glyphicon glyphicon-menu-right pull-right" title="View next legend" onclick="changeLegend(\'next\')"></span>');





      //******Change transparency of current legend layer
      function layerOpacity(tmpSlider, tmpLayer) {
        var tmpOpacity = tmpSlider.value/100; 
        tmpSlider.title = "Opacity: " + tmpSlider.value + "%"; 
        tmpLayer.setOpacity(tmpOpacity);
      } 





      //*****Make div for downloads
      d3.select("body")
        .append("div")
        .attr("class", "legend gradDown")
        .attr("id", "downloadDiv");

      $('#downloadDiv').draggable({containment: "html", cancel: "input,label,textarea,button,select,option"});

      d3.select("#downloadDiv")
        .append("h4")
        .text("Downloads")
        .attr("class", "legTitle")
        .attr("id", "downloadTitle")
        .append("span")
        .html('<span class="glyphicon glyphicon-info-sign help-tooltip" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Downloads</center></b></u></p><p>Download zip files containing GeoTIFFs for Species Occupancy layers, or a shapefile or geoJSON file of the Wildlife Opening created.</p>"></span>');
 
      d3.select("#downloadTitle")
        .append("span")
        .attr("class", "glyphicon glyphicon-remove pull-right minimize-button")
        .property("title", "Click to hide Downloads window")
        .on("click", function() { toolWindowToggle("download"); });

      d3.select("#downloadDiv")
        .append("div")
        .attr("id", "dlOptions")
        .append("select")
        .attr("id", "dlSelect")
        .attr("class", "shapeUnit")
        .style("width", "calc(100% - 10px)")
        .property("title", "Select the format of the output file")
        .append("option")
        .property("value", "zip")
        .text("Shapefile");

      d3.select("#dlSelect")
        .append("option")
        .property("value", "json")
        .text("GeoJSON");

      d3.select("#downloadDiv")
        .append("div")
        .attr("class", "legendBtn")
        .html('<a id="dlButton" href="#" title="Download the above layer to the specified format">Download</a>');






      //*****Make div for drawing & measuring
      d3.select("body")
        .append("div")
        .attr("class", "legend gradDown")
        .attr("id", "drawDiv");

      $('#drawDiv').draggable({containment: "html", cancel: "input,label,textarea,button,select,option"});

      d3.select("#drawDiv")
        .append("h4")
        .text("Draw & Measure")
        .attr("class", "legTitle")
        .attr("id", "drawTitle")
        .append("span")
        .html('<span class="glyphicon glyphicon-info-sign help-tooltip" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Draw & Measure</center></b></u></p><p>Use the drawing tools to create, edit, and remove wildlife opening areas on the map.<br><br>Use the measuring tool to determine distances between wildlife openings and landscape features (e.g. power corridors, water bodies).</p>"></span>');
 
      d3.select("#drawTitle")
        .append("span")
        .attr("class", "glyphicon glyphicon-remove pull-right minimize-button")
        .property("title", "Click to hide Draw & Measure window")
        .on("click", function() { toolWindowToggle("draw"); });







      //******Leaflet Draw toolbar
      d3.select("#drawDiv")
        .append("div")
        .attr("id", "drawToolDiv")
        .append("div")
        .attr("id", "drawToolbar")
        .html('<h4 class="shapeTitle" title="Use the below tools to draw a wildlife opening on the map">Draw Wildlife Opening</h4>');

      document.getElementById("drawToolbar").appendChild(drawControl.onAdd(map));





      //******Leaflet Measure Tool
      d3.select("#drawToolDiv")
        .append("div")
        .attr("id", "measureTool")
        .html('<h4 class="shapeTitle" title="Use the below tool to measure distances on the map">Measure Distance</h4>');

      var measureTool = new L.Control.measureControl();
      document.getElementById("measureTool").appendChild(measureTool.onAdd(map));

      //******Disable measure feature if shape is selected
      d3.select(".leaflet-draw-toolbar").selectAll("a")
        .on("click", function(d) { 
          if(d3.select(".leaflet-control-draw-measure").style("background-color") == "rgb(144, 238, 144)") {
            measureTool.toggle();
          }
          d3.select(this)
            .style("border-color", "lightgreen")
            .attr("value", "active");
        });







      //*****Make div for songs & photos
      d3.select("body")
        .append("div")
        .attr("class", "legend gradDown")
        .attr("id", "songsDiv");

      $('#songsDiv').draggable({containment: "html", cancel: "input,label,textarea,button,select,option"});

      d3.select("#songsDiv")
        .append("h4")
        .text("Bird Songs & Photos")
        .attr("class", "legTitle")
        .attr("id", "songsTitle")
        .append("span")
        .html('<span class="glyphicon glyphicon-info-sign help-tooltip" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Bird Songs & Photos</center></b></u></p><p>Listen to calls and view images of bird species found in wildlife openings.</p>"></span>');
 
      d3.select("#songsTitle")
        .append("span")
        .attr("class", "glyphicon glyphicon-remove pull-right minimize-button")
        .property("title", "Click to hide Bird Songs & Photos window")
        .on("click", function() { toolWindowToggle("songs"); });







      //*******Make Help/information div
      d3.select("body")
        .append("div")
        .attr("class", "modal fade ui-draggable in")
        .attr("id", "helpDiv")
        .style("display", "none")
        .append("div")
        .attr("class", "modal-dialog modal-lg")
        .attr("id", "infoDiv")
        .append("div")
        .attr("class", "helpTitle")
        .text("ACAF: Avian Community Assemblage Forecaster")
        .property("title", "ACAF: Avian Community Assemblage Forecaster informational details")
        .append("span")
        .attr("class", "glyphicon glyphicon-remove pull-right minimize-button")
        .attr("data-toggle", "modal")
        .attr("data-target", "#helpDiv")
        .property("title", "Close help");
        
      d3.select("#infoDiv")
        .append("div")
        .text("Helpful information coming soon...");


      //******Add in edge and area text boxes, and unit selector
      d3.select("#drawDiv")
        .append("div")
        .attr("id", "shapeDiv")
        .append("div")
        .attr("id", "edgeDiv")
        .attr("class", "shape")
        .append("h4")
        .attr("class", "shapeTitle")
        .text("Edge Length")
        .property("title", "Length of the wildlife opening perimeter");


      d3.select("#shapeDiv")
        .append("div")
        .attr("id", "areaDiv")
        .attr("class", "shape")
        .append("h4")
        .attr("class", "shapeTitle")
        .text("Opening Area")
        .property("title", "Area of the wildlife opening");

      d3.select("#edgeDiv")
        .append("input")
        .attr({type: "text"})
        .attr("id", "edgeText")
        .attr("class", "shapeVals")
        .property("title", "Length of the wildlife opening perimeter");

      d3.select("#areaDiv")
        .append("input")
        .attr({type: "text"})
        .attr("id", "areaText")
        .attr("class", "shapeVals")
        .property("title", "Area of the wildlife opening");

      var selectEdge = d3.select("#edgeDiv")
        .append("select")
        .attr("id", "edgeUnit")
        .attr("name", "Meters")
        .attr("class", "shapeUnit")
        .property("title", "Select units for edge value")
        .on("change", function() { changeUnits(this.name, this.value, d3.select("#edgeText").property("value"), "edge") });

      var tmpUnits = ["Meters", "Kilometers", "Feet", "Miles"];
      selectEdge.selectAll("option")
        .data(tmpUnits)
        .enter()
          .append("option")
            .attr("value", function(d) { return d; })
            .text(function(d) {return d; });

      selectEdge.property("selectedIndex", 1);

      var selectArea = d3.select("#areaDiv")
        .append("select")
        .attr("id", "areaUnit")
        .attr("name", "Square Meters")
        .attr("class", "shapeUnit")
        .property("title", "Select units for area value")
        .on("change", function() { changeUnits(this.name, this.value, d3.select("#areaText").property("value"), "area") });

      var tmpUnits = ["Square Meters", "Hectares", "Square Kilometers", "Square Feet", "Acres", "Square Miles"];
      selectArea.selectAll("option")
        .data(tmpUnits)
        .enter()
          .append("option")
            .attr("value", function(d) { return d; })
            .text(function(d) {return d; });

      selectArea.property("selectedIndex", 2);

      //Format edge and area values by selected unit
      function changeUnits(oldUnit, unit, val, type) {
        val = backChangeUnits(oldUnit, val);
        switch (unit) {
          case "Meters":
            var newVal = val;
            break;
          case "Kilometers":
            var newVal = (val/1000);
            break;
          case "Feet":
            var newVal = (val*3.2808);
            break;
          case "Miles":
            var newVal = (val*0.00062137);
            break;
          case "Square Meters":
            var newVal = val;
            break;
          case "Hectares":
            var newVal = (val/10000);
            break;
          case "Square Kilometers":
            var newVal = (val/1000000);
            break;
          case "Square Feet":
            var newVal = (val*10.764);
            break;
          case "Acres":
            var newVal = (val*0.00024711);
            break;
          case "Square Miles":
            var newVal = (val*0.00000038610216);
            break;
        }

        if (type == "edge") {
          d3.select("#edgeText").attr("value", newVal.toFixed(2));
          d3.select("#edgeUnit").attr("name", unit);
        }
        else {
          d3.select("#areaText").attr("value", newVal.toFixed(2));
          d3.select("#areaUnit").attr("name", unit);
        }
      }      

      function backChangeUnits(unit, val) {
        switch(unit) {
          case "Meters":
            return val;
            break;
          case "Kilometers":
            return (val*1000);
            break;
          case "Feet":
            return (val/3.2808);
            break;
          case "Miles":
            return (val/0.00062137);
            break;
          case "Square Meters":
            return val;
            break;
          case "Hectares":
            return (val*10000);
            break;
          case "Square Kilometers":
            return (val*1000000);
            break;
          case "Square Feet":
            return (val/10.764);
            break;
          case "Acres":
            return (val/0.00024711);
            break;
          case "Square Miles":
            return (val/0.00000038610216);
            break;
        }
      }

      //******Add in bird song and pictures
      d3.select("#songsDiv")
        .append("div")
        .attr("id", "songs")
        .append("h4")
        .attr("id", "species")
        .text("Spinus tristis");

      d3.select("#songs")
        .append("img")
        .attr("id", "birdPic")
        .attr("src", "bird_pics/american_goldfinch.jpg");

      d3.select("#songs")
        .append("audio")
        .attr("src", "bird_songs/american_goldfinch.mp3")
        .attr("controls", "controls")
        .attr("id", "birdSong");

      //***Control Volume
      //d3.select("#birdSong").property("volume", 0.5);
      //***Control start/stop
      //d3.select("#birdSong")[0][0].play();
      //d3.select("#birdSong")[0][0].pause();
      //d3.select("#birdSong")[0][0].load();

      //******Download external data files
      var birds = {}; //global birds variable
      queue()
        .defer(d3.tsv, 'bird_media.tsv')
        .await(loadData);

      //******Load external data into JSON
      function loadData(error, mediaData) {
        birds.keys = d3.keys(mediaData[0]);
        birds.latin = {};
        
        birds.media = mediaData.map(function(d) {
          var tmpJSON = {};
          var tmpVals = d3.values(d);
          tmpVals.forEach(function(val,i) {
            tmpJSON[birds.keys[i]] = d[birds.keys[i]];
          });
          return tmpJSON;
        });

        birds.media.forEach(function(d) { birds.latin[d.id] = d.latin; });

        //******Add selection to change bird media
        var select = d3.select("#songs")
          .append("select")
          .attr("id", "songSelect")
          .attr("class", "shapeUnit")
          .property("title", "Select species to hear its song and display a photo")
          .on("change", function() {
            d3.select("#species").text(birds.latin[this.value]);
            d3.select("#birdPic").attr("src", "bird_pics/" + this.value + ".jpg");
            d3.select("#birdSong").attr("src", "bird_songs/" + this.value + ".mp3");
            d3.select("#birdSong")[0][0].play();
          });

        select.selectAll("option")
          .data(birds.media)
          .enter()
            .append("option")
              .attr("value", function(d) { return d.id; })
              .text(function(d) { return d.common; });

      }
    </script>
  </body>
</html>