<!DOCTYPE html>
<html>
  <head>
    <title>PACT: Predictor of Avian Communities Tool</title>
    <link rel="icon" type="image/png" href="images/bird-favicon.ico">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">

    <!--link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css"/-->
    <link rel="stylesheet" href="styles/bootstrap.min.css"/>
    <!--link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intro.js/2.4.0/introjs.min.css"/-->
    <link rel="stylesheet" href="introjs.min.css"/>
    <!--link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css"/-->
    <link rel="stylesheet" href="leaflet.css"/>
    <!--link rel="stylesheet" href="http://colorbrewer2.org/export/colorbrewer.css"/-->
    <link rel="stylesheet" href="colorbrewer.css"/>
    <link rel="stylesheet" href="styles/Control.BingGeocoder.css"/>
    <link rel="stylesheet" href="styles/Control.maxExtent.css"/>
    <link rel="stylesheet" href="leaflet-draw/dist/leaflet.draw.css"/>
    <link rel="stylesheet" href="styles/Control.mousePosition.css"/>
    <link rel="stylesheet" href="styles/Control.print.css"/>
    <link rel="stylesheet" href="styles/birds.css"/>

    <!--script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script-->
    <script src="leaflet.js"></script>
    <!--script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script-->
    <script src="jquery-3.2.1.min.js"></script>
    <script src="jquery-ui.min.js"></script>
    <!--script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script-->
    <script src="bootstrap.min.js"></script>
    <!--script src="https://maps.google.com/maps/api/js?v=3"></script-->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBk-pRMxjeu0G6yIfxqnZMPQE5LgLLB6P8"></script>
    <script src="bundle.js"></script>
    <script src="Bing_tile.js"></script>
    <script src="Google_tile.js"></script>
    <script src="Control.BingGeocoder.js"></script>
    <script src="Control.maxExtent.js"></script>
    <script src="leaflet-draw/dist/leaflet.draw.js"></script>
    <script src="Control.mousePosition.js"></script>
    <script src="Control.downLoadFile.js"></script>
    <script src="Control.print.js"></script>
    <script src="https://pact.ecosheds.org/socket.io/socket.io.js"></script>
    <script src="socket_emit.js"></script>
    <!--script src="http://d3js.org/d3.v3.min.js"></script-->
    <script src="d3.v5.min.js"></script>
    <script src="d3.v3.min.js"></script>
    <!--script src="http://d3js.org/topojson.v1.min.js"></script-->
    <script src="topojson.v1.min.js"></script>
    <!--script src="http://colorbrewer2.org/export/colorbrewer.js"></script-->
    <script src="colorbrewer.js"></script>
    <!--script src="https://cdnjs.cloudflare.com/ajax/libs/queue-async/1.0.7/queue.min.js"></script-->
    <script src="queue.min.js"></script>
    <script src="crossfilter.min.js"></script>
    <script src="shapefile.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-130578747-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-130578747-1');
    </script>
  </head>

  <body>
    <div id="map"></div>

    <script type='text/javascript'>
      //******Connect to postgresql database
      socket_emit();

      //******Initialize bootstrap tooltip
      $(document).ready(function(){
        $('[data-toggle="tooltip"]').tooltip();   
      });

      //******Call funtion to reposition windows on resize
      window.addEventListener('resize', resizePanels);

      function resizePanels() {
        var bodyRect = document.body.getBoundingClientRect();
        var tmpWindows = ["legendDiv", "drawDiv", "resultsDiv", "songsDiv", "downloadDiv", "graphsDiv"];
        
        tmpWindows.forEach(function(win) {
          var winRect = document.getElementById(win).getBoundingClientRect();
          if(winRect.bottom > bodyRect.bottom) {
            d3.select("#" + win).style("top", bodyRect.height - winRect.height + "px");
          }
          if(winRect.right > bodyRect.right) {
            d3.select("#" + win).style("left", bodyRect.width - winRect.width + "px");
          }
        });

        //***Resize species dropdown list
        d3.select("#birdListDropdown").style("max-height", window.innerHeight - 75 + "px");
      }


      //******Add Map
      //var map = new L.Map('map', {center: new L.LatLng(42.2, -72.03), zoomControl: false, zoom: 9, minZoom: 7, maxZoom: 20, inertiaDeceleration: 1000, maxBounds: new L.LatLngBounds(new L.LatLng(40.6,-82.3), new L.LatLng(48.3,-61.3))});
      var map = new L.Map('map', {center: new L.LatLng(42.2, -72.03), zoomControl: false, zoom: 9, minZoom: 2, maxZoom: 20, inertiaDeceleration: 1000});

      //geoJSON holding variable
      var tmpGeo;

      //******Add map controls
      L.control.scale({ maxWidth: 200 }).addTo(map);
      L.control.mousePosition().addTo(map);
      L.control.zoom({ position: 'bottomright', zoomInTitle: "Zoom in (can also be done with mouse wheel, double-click, '+' key, or by pressing the 'shift' key while clicking and dragging a rectangle)", zoomOutTitle: "Zoom out (can also be done with the mouse wheel or the '-' key)" }).addTo(map);
      L.control.maxExtent().addTo(map);

      //******Add draw controls
      var drawnItems = new L.FeatureGroup();
      map.addLayer(drawnItems);

      var drawControl = new L.Control.Draw({
      	draw: {
          position: 'topleft',
          polygon: {allowIntersection: false, drawError: {color: '#b00b00', timeout: 1500}, shapeOptions: {color: '#ff33cc'}, showArea: true, metric: ['ha']},
          rectangle: {shapeOptions: {color: '#ff33cc'}, showArea: true, metric: ['ha']},
          circle: false,
          //circle: {shapeOptions: {color: '#ff33cc'}, showArea: true},
          //polyline: {shapeOptions: {color: '#ff33cc'}},
          polyline: false,
          marker: false,
          circlemarker: false
      	},
      	edit: {
          featureGroup: drawnItems,
          edit: {selectedPathOptions: {maintainColor: true, opacity: 1, fillOpacity: 0.2}},
          poly: {allowIntersection: false, drawError: {color: '#b00b00', timout: 1500}}
      	}
      });

      map.on('draw:created', function (e) {
        if(d3.select("#drawToolbar").select(".leaflet-draw-actions").style("display") == "block") { 
          getShape(e.layerType, e.layer); 
          e.layer.on("edit", updateShape);       
          drawnItems.addLayer(e.layer);
          drawnItems._layers[L.stamp(e.layer)]["layerType"] = e.layerType;
          d3.select(".leaflet-draw-section").style("pointer-events", "none").style("opacity", "0.4");
          layerID = e.layer._leaflet_id;
          d3.select("#exportDefaultDiv").style("display", "none");
          d3.select("#exportActualDiv").style("display", "block");
          d3.selectAll("#hcExportDiv,#hcZoomDiv,#hcRunDiv").classed("inactive", false);
          d3.select("#enableImport").classed("disabled", true);
        }
      });

      map.on('draw:deleted', function (e) {
        d3.select(".leaflet-draw-section").style("pointer-events", "auto").style("opacity", "1");
        d3.select(".leaflet-draw-section").style("opacity", "1");
        d3.select("#edgeText").attr("value", "");
        d3.select("#areaText").attr("value", "");
        d3.select("#exportDefaultDiv").style("display", "block");
        d3.select("#exportActualDiv").style("display", "none");
        d3.selectAll("#hcExportDiv,#hcZoomDiv,#hcRunDiv,#hcResultsDiv").classed("inactive", true);
        ["export", "results", "graphs"].forEach(function(d) { if(d3.select("#" + d + "Div").style("opacity") == "1") {toolWindowToggle(d);} });
        d3.select("#graphs").selectAll("div").remove();
        d3.select("#enableImport").classed("disabled", false);
      });

      map.on('draw:editmove', function (e) {
        getShape(e.layer.layerType, e.layer);        
      });

      map.on('draw:editresize', function (e) {
        getShape(e.layer.layerType, e.layer);        
      });

      map.on('draw:editvertex', function (e) {
        //getShape(e.layer.layerType, e.layer);        
      });

      map.on('draw:editstop', function (e) {
        getShape(drawnItems.getLayer(layerID).layerType, drawnItems.getLayer(layerID));        
      });

      function updateShape(e) {
        getShape(e.target.layerType, e.target);
      }

      //******Add ability to measure polygon perimeter
      L.Polyline.include({
        length: function () {
          var latlngs = this.getLatLngs();
          var length = 0;
          for (var i = 0, n = latlngs.length - 1; i< n; i++) {
            length += latlngs[i].distanceTo(latlngs[i+1]);
          }
          return length;
        }
      });

      L.Polygon.include({
        perimeter: function () {
          var length = L.Polyline.prototype.length.call(this);
          var latlngs = this.getLatLngs();
          if (latlngs.length > 2) {
            length += latlngs[0].distanceTo(latlngs[latlngs.length - 1]);
          }
          return length;
        }
      });

      L.Circle.include({
        circumference: function () {
          var radius = this.getRadius();
          var length = 2 * Math.PI * radius;
          return length
        }
      });

      L.Circle.include({
        area: function () {
          var radius = this.getRadius();
          var length = Math.PI * (radius * radius);
          return length
        }
      });



      function getShape(type, layer) {
        switch (type) {
          case 'polygon':
            var length = layer.perimeter();
            var area = L.GeometryUtil.geodesicArea(layer.getLatLngs());
            break;
          case 'rectangle':
            var length = layer.perimeter();
            var area = L.GeometryUtil.geodesicArea(layer.getLatLngs());
            break;
          case 'circle':
            var length = layer.circumference();
            var area = layer.area();
            break;
          case 'marker':
            layer.bindPopup(e.layer._latlng.lat.toFixed(3) + ", " + e.layer._latlng.lng.toFixed(3));
            break;
          case 'draw:editresize':
            var length = layer.perimeter();
            var area = L.GeometryUtil.geodesicArea(layer.getLatLngs());
            break;            
        }      

        changeUnits("Meters", d3.select("#edgeUnit").property("value"), length, "edge");
        d3.select("#edgeText")
          .attr("data-m", length);

        changeUnits("Square Meters", d3.select("#areaUnit").property("value"), area, "area");
        d3.select("#areaText")
          .attr("data-ha", area/10000)
          .attr("data-sq_m", area);

        //***Add geojson of drawn feature to export button
        setTimeout(function() {
          socket.emit("check_stats", {"geom": drawnItems.toGeoJSON().features[0].geometry, "version": "alfl_OH"});
          setExport();
        },500);
      }


      //******Add shapefile or geojson format to download button
      function setExport() {
        if(document.querySelector('input[name=exportFormat]:checked').value == "geojson") {
          d3.select("#exportFileButtonA")
            .property("download", "opening.geojson")
            .property("href", "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(drawnItems.toGeoJSON())));
        }
        else { 
          var shpwrite = require('shp-write');
          
          var options = {
            folder: "opening",
            types: {
              point: "opening",
              polygon: "opening",
              line: "opening",
              polyline: "opening"
            }
          }        

          var byteString = shpwrite.zip(drawnItems.toGeoJSON(), options);
          var byteCharacters = window.atob(byteString);
          var byteNumbers = new Array(byteCharacters.length);
          for (var i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
          }
          var byteArray = new Uint8Array(byteNumbers);
          var blob = new Blob([byteArray], {type: 'application/zip'});
          var url = URL.createObjectURL(blob);
          d3.select("#exportFileButtonA")
            .property("download", "opening.zip")
            .property("href", url);
        } 
      }




      //***Bing geocoder control
      var tmpPoint = new L.marker;
      var bingGeocoder = new L.Control.BingGeocoder('At3gymJqaoGjGje-JJ-R5tJOuilUk-gd7SQ0DBZlTXTsRoMfVWU08ZWF1X7QKRRn', { callback: function (results)
        {
          if(results.statusCode == 200) {
            if(d3.select("#bingGeocoderSubmit").classed("glyphicon-search")) {
              $(document).ready(function(){
                $('[data-toggle="tooltip"]').tooltip();   
              });
              document.getElementById("bingGeocoderInput").blur();
              var bbox = results.resourceSets[0].resources[0].bbox,
                first = new L.LatLng(bbox[0], bbox[1]),
                second = new L.LatLng(bbox[2], bbox[3]),
                tmpBounds = new L.LatLngBounds([first, second]);
              this._map.fitBounds(tmpBounds);
              this._map.removeLayer(tmpPoint);
              tmpPoint = new L.marker(results.resourceSets[0].resources[0].point.coordinates);  //.bindPopup(results.resourceSets[0].resources[0].address.formattedAddress);
              this._map.addLayer(tmpPoint);
              d3.select(".leaflet-marker-icon")
                .attr("id","mapIcon")
                .attr("value", results.resourceSets[0].resources[0].name)
                .attr("data-toggle", "tooltip")
                .attr("data-container", "body")
                .attr("data-placement", "auto top")
                .attr("data-html", "true")
                .attr("title", '<p><b><center>' + results.resourceSets[0].resources[0].name + '</center></b></p>');
              d3.select(tmpPoint)
                .on("click", function() { clearSearch(); });
              d3.select("#bingGeocoderSubmit")
                .classed("glyphicon-search", false)
                .classed("glyphicon-remove", true)
                .property("title", "Click to clear search results");
            }
            else {
              clearSearch();
            }
          }
          else {
            d3.select("#bingGeocoderInput").property("value","No matching results");            
          }
        }
      });

      //******Clear the results of the geo search
      function clearSearch() {
        map.removeLayer(tmpPoint);
        d3.select(".tooltip").remove();
        d3.select("#bingGeocoderInput").property("value", "");

        d3.select("#bingGeocoderSubmit")
          .classed("glyphicon-remove", false)
          .classed("glyphicon-search", true)
          .style({"background":"", "color":""})
          .property("title", "Click to zoom to specified location");
      }



      //******Add base layers
      var googleHybrid = L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}',{
        maxZoom: 20,
        subdomains:['mt0','mt1','mt2','mt3']
      });
      var googleSatellite = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{
        maxZoom: 20,
        subdomains:['mt0','mt1','mt2','mt3']
      }); 
      var googleStreet = L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{
        maxZoom: 20,
        subdomains:['mt0','mt1','mt2','mt3']
      });
      var googleTerrain = googleTerrain = L.tileLayer('http://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}',{
        maxZoom: 20,
        subdomains:['mt0','mt1','mt2','mt3']
      });

      var bingHybrid = new L.BingLayer("At3gymJqaoGjGje-JJ-R5tJOuilUk-gd7SQ0DBZlTXTsRoMfVWU08ZWF1X7QKRRn", {type: 'AerialWithLabels'});
      var bingSatellite = new L.BingLayer("At3gymJqaoGjGje-JJ-R5tJOuilUk-gd7SQ0DBZlTXTsRoMfVWU08ZWF1X7QKRRn", {type: 'Aerial'});
      var bingStreet = new L.BingLayer("At3gymJqaoGjGje-JJ-R5tJOuilUk-gd7SQ0DBZlTXTsRoMfVWU08ZWF1X7QKRRn", {type: 'Road'});
      var usgsTopo = new L.tileLayer('http://basemap.nationalmap.gov/ArcGIS/rest/services/USGSTopo/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 15,
            zIndex: 0,
            attribution: '<a href="http://www.doi.gov">U.S. Department of the Interior</a> | <a href="http://www.usgs.gov">U.S. Geological Survey</a> | <a href="http://www.usgs.gov/laws/policies_notices.html">Policies</a>'
            });
      var states = new L.tileLayer.wms("https://ecosheds.org/geoserver/birds/wms", {
          layers: 'us_states',
          format: 'image/png',
          transparent: true,
          version: '1.1.0',
          maxZoom: 20,
        });
      var bcr = new L.tileLayer.wms("https://ecosheds.org/geoserver/birds/wms", {
          layers: 'bcr_regions_states',
          format: 'image/png',
          transparent: true,
          version: '1.1.0',
          maxZoom: 20,
        });

      var blank = new L.tileLayer('');
    
      var states2 = new L.tileLayer.wms("https://ecosheds.org/geoserver/birds/wms", {
          layers: 'us_states',
          format: 'image/png',
          transparent: true,
          version: '1.1.0',
          maxZoom: 20,
        });


      //******Add Geoserver Layers
      var birdTitles = ["Alder Flycatcher","American Goldfinch","Black-and-white Warbler","Blue-winged Warbler","Brown Thrasher","Canada Warbler","Cedar Waxwing","Chestnut-sided Warbler","Common Yellowthroat","Dark-eyed Junco","Eastern Towhee","Field Sparrow","Golden-winged Warbler","Gray Catbird","Indigo Bunting","Mourning Warbler","Nashville Warbler","Prairie Warbler","Song Sparrow","White-eyed Vireo","White-throated Sparrow","Yellow-billed Cuckoo"];
      var birdID = ["alfl_OH","amgo_OH","baww_OH","bwwa_OH","brth_OH","cawa_OH","cewa_OH","cswa_OH","coye_OH","deju_OH","eato_OH","fisp_OH","gwwa_OH","grca_OH","inbu_OH","mowa_OH","nawa_OH","praw_OH","sosp_OH","wevi_OH","wtsp_OH","ybcu_OH"];
      //var birdTitles = ["Alder Flycatcher","American Goldfinch","American Woodcock","Black and White Warbler","Blue-winged Warbler","Brown Thrasher","Canada Warbler","Carolina Wren","Cedar Waxwing","Chestnut-sided Warbler","Common Yellowthroat","Dark-eyed Junco","Eastern Towhee","Field Sparrow","Golden-winged Warbler","Gray Catbird","House Wren","Indigo Bunting","Lincoln's Sparrow","Magnolia Warbler","Mourning Warbler","Nashville Warbler","Northern Bobwhite","Northern Cardinal","Northern Mockingbird","Palm Warbler","Prairie Warbler","Ruby-throated Hummingbird","Ruffed Grouse","Rusty Blackbird","Song Sparrow","Swamp Sparrow","Tennessee Warbler","White-eyed Vireo","White-throated Sparrow","Willow Flycatcher","Wilson's Snipe","Wilson's Warbler","Yellow Warbler","Yellow-billed Cuckoo","Yellow-breasted Chat"];
      //var birdID = ["alfl","amgo","amwo","baww","bwwa","brth","cawa","cawr","cewa","cswa","coye","deju","eato","fisp","gwwa","grca","howr","inbu","lisp","mawa","mowa","nawa","nobo","noca","nomo","pawa","praw","rthu","rugr","rubl","sosp","swsp","tewa","wevi","wtsp","wifl","wisn","wiwa","yewa","ybcu","ybch"];
      var birdLayers = [];
      birdID.forEach(function(spp, i) {
        birdLayers[i] = L.tileLayer.wms("https://ecosheds.org/geoserver/birds/wms", {
          layers: 'birds:' + spp,
          format: 'image/png',
          transparent: true,
          version: '1.1.0',
          maxZoom: 20
        });
      });


/*
      var gsTowns = L.tileLayer.wms("https://ecosheds.org/geoserver/crossings/wms", {
        layers: 'crossings:deerfield_towns',
        format: 'image/png',
        transparent: true,
        version: '1.1.0',
        maxZoom: 20
      });

      var gsCounties = L.tileLayer.wms("https://ecosheds.org/geoserver/crossings/wms", {
        layers: 'crossings:deerfield_counties',
        format: 'image/png',
        transparent: true,
        version: '1.1.0',
        maxZoom: 20
      });

      var gsDOTDistricts = L.tileLayer.wms("https://ecosheds.org/geoserver/crossings/wms", {
        layers: 'crossings:deerfield_dot_districts',
        format: 'image/png',
        transparent: true,
        version: '1.1.0',
        maxZoom: 20
      });

      var gsHUC12 = L.tileLayer.wms("https://ecosheds.org/geoserver/crossings/wms", {
        layers: 'crossings:deerfield_huc12',
        format: 'image/png',
        transparent: true,
        version: '1.1.0',
        maxZoom: 20
      });
*/

      //******Add Download tool
      var downLoadFile = new L.Control.downLoadFile();

      //******Add Print tool
      var printMap = new L.Control.print();



      //******Make layer controller
      //***baselayers
      var layerNames = {};
      layerNames.baseLayers = {"Google Terrain": googleTerrain, "Google Hybrid": googleHybrid, "Google Satellite": googleSatellite, "Google Street": googleStreet, "Bing Hybrid": bingHybrid, "Bing Satellite": bingSatellite, "Bing Street": bingStreet, "USGS Topo": usgsTopo, "State Outlines": states, "BCR": bcr, "None": blank};
      layerNames.baseLayers.keys = d3.keys(layerNames.baseLayers);
      layerNames.baseLayers.values = d3.values(layerNames.baseLayers);

      //***Bird layers
      layerNames.birds = {};
      birdTitles.forEach(function(tmpTitle,i) {
        layerNames.birds[tmpTitle] = birdLayers[i];
      });
      layerNames.birds.keys = d3.keys(layerNames.birds);
      layerNames.birds.values = d3.values(layerNames.birds);




      //******Make header div
      d3.select("body")
        .append("div")
        .attr("class", "header")
        .html('<span class="brand">PACT: Predictor of Avian Communities Tool</span><div id="headerLinks"><a id="showWelcome" href="#" title="Click to show the welcome screen" onclick="d3.select(&quot;#splashScreen&quot;).style(&quot;display&quot;,&quot;flex&quot;)">Welcome</a><a title="Click to display information on how to use this tool" href="#" data-toggle="modal" data-target="#helpDiv">About PACT</a><a title="Click to go to the Ecosheds homepage" href="http://ecosheds.org" target="_blank">SHEDS Home</a></div><div id="printDownload" class="pull-right"><span id="legendControl" class="glyphicon glyphicon-list" title="View legend window" onclick="toolWindowToggle(&quot;legend&quot;)"></span><span id="songControl" class="glyphicon glyphicon-music" title="View bird song window" onclick="toolWindowToggle(&quot;songs&quot;)"></span><span id="downloadControl" class="glyphicon glyphicon-download-alt" title="Download spatial data" onclick="toolWindowToggle(&quot;download&quot;)"></span><span id="printControl" class="glyphicon glyphicon-print" title="Print current map" onclick="window.print()"></span></div>');



      //******Make headerControls div
      d3.select("body")
        .append("div")
        .attr("id", "headerControls");



      //******Add toolbar tools
      //***Baselayers
      d3.select("#headerControls")
        .append("div")
        .attr("id", "mapTools")
        .append("div")
        .attr("id", "baselayerSelect")
        .attr("class", "layerList")
        .append("div")
        .attr("id", "baselayerList")
        .attr("class", "cl_select")
        .property("title", "Click to change map baselayer")
        .html('<span id="baselayerListHeader">Change Baselayer</span><span class="glyphicon glyphicon-triangle-bottom pull-right" style="position:relative;top:3px;"></span>')
        .on("click", function() { if(d3.select("#baselayerListDropdown").style("display") == "none") {d3.select("#baselayerListDropdown").style("display", "inline-block");} else {d3.select("#baselayerListDropdown").style("display", "none");} });;

      d3.select("#baselayerSelect")
        .append("div")
        .attr("id", "baselayerListDropdown")
        .attr("class", "layerListDropdown")
        .on("mouseleave", function() { d3.select(this).style("display", "none") });

      //******Add baselayer options
      d3.select("#baselayerListDropdown").selectAll("div")
        .data(layerNames.baseLayers.keys)
        .enter()
          .append("div")
          .attr("class", "layerName")
          .text(function(d) { return d; })
          .property("value", function(d,i) { return i; })
          .property("title", function(d) { return d; })
          .on("click", function() { changeBaselayer(this); })
          .append("span")
          .attr("class", "glyphicon glyphicon-ok pull-right activeOverlay")
          .style("visibility", function(d,i) { if(i == 1) {return "visible";} else {return "hidden";} });


      //******Initialize baselayer
      map.addLayer(googleHybrid);

      //******Function to change baselayer on select change
      function changeBaselayer(tmpDiv) {
        //***Remove old layer
        var layerDivs = d3.select("#baselayerListDropdown").selectAll("div");
        
        layerDivs[0].forEach(function(tmpLayer) {
          if(d3.select(tmpLayer).select("span").style("visibility") == "visible") {
            d3.select(tmpLayer).select("span").style("visibility", "hidden");
            map.removeLayer(layerNames.baseLayers.values[d3.select(tmpLayer).property("value")]);
          }
        });

        //***Add new layer
        d3.select(tmpDiv).select("span").style("visibility", "visible");
        map.addLayer(layerNames.baseLayers.values[tmpDiv.value]);
        layerNames.baseLayers.values[tmpDiv.value].bringToBack();       
      }






      //***Bird layers
      d3.select("#mapTools")
        .append("div")
        .attr("id", "birdSelect")
        .attr("class", "layerList")
        .append("div")
        .attr("id", "birdList")
        .attr("class", "cl_select")
        .property("title", "Click to select regional species occupancy layers to display on the map")
        .html('<span id="birdListHeader">Regional Occupancy Layers</span><span class="glyphicon glyphicon-triangle-bottom pull-right" style="position:relative;top:3px;"></span>')
        .on("click", function() { if(d3.select("#birdListDropdown").style("display") == "none") {d3.select("#birdListDropdown").style("display", "inline-block"); resizePanels();} else {d3.select("#birdListDropdown").style("display", "none");} });;

      d3.select("#birdSelect")
        .append("div")
        .attr("id", "birdListDropdown")
        .attr("class", "layerListDropdown")
        .on("mouseleave", function() { d3.select(this).style("display", "none") });

      //******Add bird options
      d3.select("#birdListDropdown").selectAll("div")
        .data(layerNames.birds.keys)
        .enter()
          .append("div")
          .attr("class", "layerName")
          .text(function(d) { return d; })
          .property("value", function(d,i) { return i; })
          .property("title", function(d) { return d; })
          .property("name", function(d,i) { return birdID[i]; })
          .on("click", function() { changeBird(this); })
          .append("span")
          .attr("class", "glyphicon glyphicon-ok pull-right activeBird")
          .style("visibility", "hidden");




      //******Function to add/remove bird layer
      function changeBird(tmpDiv) {
        if(d3.select(tmpDiv).select("span").style("visibility") == "hidden") {
          d3.select(tmpDiv).select("span").style("visibility", "visible");
          map.addLayer(layerNames.birds.values[tmpDiv.value]);
          layerNames.birds.values[tmpDiv.value].bringToFront();
          addLegendImg(tmpDiv.name, tmpDiv.title, layerNames.birds.values[tmpDiv.value], ["birds",tmpDiv.title]);
          if(legendDivs.length == 1) {
            map.addLayer(states2);
          }
          states2.bringToFront();
        } 
        else {
          d3.select(tmpDiv).select("span").style("visibility", "hidden");
          map.removeLayer(layerNames.birds.values[tmpDiv.value]);
          remLegendImg(tmpDiv.name);
          if(legendDivs.length == 0) {
            map.removeLayer(states2);
          }
          else {
            states2.bringToFront();
          }
        }
      }





      //******Add geolocater
      d3.select("#headerControls")
        .append("div")
        .attr("id", "bingGeoLocate");
        //.attr("class", "layerList");

      document.getElementById('bingGeoLocate').appendChild(bingGeocoder.onAdd(map));
      d3.select("#bingGeocoderInput")
        .on("mouseup", function() { if(this.value == "No matching results") { this.value = ""; } else { $(this).select(); } })
        .on("blur", function() { modifySearch(this, "blur"); })
        .on("keyup", function() { modifySearch(this, "key"); }); // if(d3.event.keyCode == 13) { if(d3.select("#bingGeocoderSubmit").classed("glyphicon-remove") == true) { $("#bingGeocoderSubmit").click(); } } });



      function modifySearch(tmpEl, tmpEvent) {
        if(tmpEvent == "blur") {
          if((tmpEl.value == "" || tmpEl.value == "No matching results") && document.getElementById("mapIcon")) { 
            tmpEl.value = d3.select("#mapIcon").attr("value"); 
            d3.select("#bingGeocoderSubmit").classed("glyphicon-remove", true).classed("glyphicon-search", false);
          }
          else if(tmpEl.value == "No matching results" && !document.getElementById("mapIcon")) {
            tmpEl.value = "";
          }
        } 
        else if(document.getElementById("mapIcon")) {
          if(tmpEl.value != d3.select("#mapIcon").attr("value")) {
            d3.select("#bingGeocoderSubmit").classed("glyphicon-remove", false).classed("glyphicon-search", true);
          }
          else {
            d3.select("#bingGeocoderSubmit").classed("glyphicon-remove", true).classed("glyphicon-search", false);
          }
        }
      }






      //Add panel icons
      d3.select("#headerControls")
        .append("div")
        .attr("id", "panelTools")
        .html('<p id="wildOpen">Management Opening:</p>');

      //var hcPanels = ["draw", "export", "zoom", "run", "results"];
      var hcPanels = ["draw", "export", "zoom", "results"];
      //var hcGlyphs = ["glyphicon-pencil", "glyphicon-export", "glyphicon-zoom-in", "glyphicon-play", "glyphicon-list-alt"];
      var hcGlyphs = ["glyphicon-pencil", "glyphicon-export", "glyphicon-zoom-in", "glyphicon-list-alt"];
      //var hcLabel = ["Add", "Export", "Zoom", "Analyze", "Results"]
      var hcLabel = ["Add", "Export", "Zoom", "Results"]
      d3.select("#panelTools").selectAll("divs")
        .data(hcPanels)
        .enter()
          .append("div")
          .attr("id", function(d) { return "hc" + d.charAt(0).toUpperCase() + d.slice(1) + "Div"; })
          .attr("class", function(d) { if(d == "draw") {return "hcPanelDivs layerList";} else {return "hcPanelDivs layerList inactive";} })
          .attr("data-toggle", function(d) { if(d == "view") {return "modal";} })
          .attr("data-target", function(d) { if(d == "view") {return "#backgroundDiv";} })
          .property("title", function(d,i) {
            if(d == "zoom") {
              return "Click to zoom to management opening";
            }
            else if(d == "run") {
              return "Click to retrieve species' occupancy probabilities for the management opening";
            }
            else {
              return "Click to show " + hcLabel[i] + " window"; 
            }
          })
          .html(function(d,i) { return '<span class="glyphicon ' + hcGlyphs[i] + '"></span><p>' + hcLabel[i] + '</p>'; })
          .on("click", function(d) { 
            switch (d) {
              case "draw":
                toolWindowToggle(d);
                break;
              case "export":
                toolWindowToggle(d);               
                break;
              case "zoom":
                var tmpCoords = drawnItems.getBounds();
                map.fitBounds([[tmpCoords._northEast.lat, tmpCoords._northEast.lng],[tmpCoords._southWest.lat, tmpCoords._southWest.lng]]);
                break;
              case "run":
                if((document.querySelector('input[name=sourcePop]:checked').value == "yes" && isNaN(parseInt(d3.select("#openSourceDist").property("value"))) == false) || document.querySelector('input[name=sourcePop]:checked').value == "no") {
                  d3.select("#waitingDiv").style("display", "block");
                  d3.select("#graphs").selectAll("div").remove();
                  socket.emit("get_bcr", {"geom": drawnItems.toGeoJSON().features[0].geometry});
                  setTimeout(function() {
                    graphSpp.forEach(function(spp) { addGraphs(spp); });
                  }, 1000);
                }
                else {
                  d3.select("#alertDiv").style("display", "block");
                }
                break;
              case "results":
                toolWindowToggle(d);
                break;
            }
          });






      //******Function to toggle tool windows
      var toggleWords = {"legend":"Layers", "draw":"Add Management Opening", "export":"Export Management Opening", "songs":"Bird Songs & Photos", "download":"Downloads"}

      function toolWindowToggle(tmpDiv) {
        if (d3.select("#" + tmpDiv + "Div").style("opacity") == "1") {
          d3.select("#" + tmpDiv + "Div").transition().style({"opacity":"0", "visibility":"hidden"});
          d3.select("#hc" + tmpDiv.charAt(0).toUpperCase() + tmpDiv.slice(1) + "Div").property("title", "Click to show " + toggleWords[tmpDiv] + " window");
          if(tmpDiv == "songs") { d3.select("#birdSong")[0][0].pause(); }
          if(tmpDiv == "results" && d3.select("#graphsDiv").style("opacity") == "1") { toolWindowToggle("graphs"); }
        }
        else {
          d3.select("#" + tmpDiv + "Div").transition().duration(250).ease("cubic").style({"opacity":"1", "display":"block", "visibility":"visible"});            
          d3.select("#hc" + tmpDiv.charAt(0).toUpperCase() + tmpDiv.slice(1) + "Div").property("title", "Click to hide " + toggleWords[tmpDiv] + " window");
          setZ(d3.select("#" + tmpDiv + "Div")[0][0]);
        }
      }






      function setZ(tmpWin) {
        if (d3.select("#map").classed("introjs-showElement") == false) {
          d3.selectAll("#legendDiv,#drawDiv,#exportDiv,#resultsDiv,#songsDiv,#downloadDiv,#graphsDiv").style("z-index", function() { if(d3.select(this).style("opacity") == 1) {return 1001;} else {return 7500;} }); 
          d3.select(tmpWin).style("z-index", 1002);
        }
      }





      //******Adds images to the legend
      var legendDivs = [];   //global array of active legends

      function addLegendImg(tmpName, tmpTitle, tmpLayer, tmpPath) {
        tmpLayer.setOpacity(1);

        legendDivs.push(tmpName);
        d3.selectAll(".layerLegend").style("display", "none");

        d3.select("#legendImgDiv")
          .append("div")
          .attr("id", tmpName + "Legend")
          .attr("value", tmpPath)
          .attr("class", "layerLegend")
          .style({"margin-top":"25px","opacity":"0"})
          .append("h3")
          .attr("class", "legendTitle")
          .text(tmpTitle);

        d3.select("#" + tmpName + "Legend")
          .append("div")
          .attr("id", tmpName + "LegImgDiv")
          .attr("class","legImgDiv")
          .append("img")
          .attr("id", tmpName + "LegendImg")
          .attr("class", "legendImg")
          //.attr("src", "https://ecosheds.org/geoserver/wms?REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&WIDTH=30&HEIGHT=30&LAYER=birds:" + tmpName)
          .property("title", tmpTitle);

        //***Set div width and offset after the image has been loaded
        $("#" + tmpName + "LegendImg").one("load", function() {
          var tmpRect = document.getElementById(tmpName + "LegendImg").getBoundingClientRect();

          d3.select("#" + tmpName + "LegImgDiv").style({"max-height":tmpRect.height - 67 + "px", "max-width": tmpRect.width + "px"});
          d3.select("#" + tmpName + "LegendImg").style("top", "-69px");

          d3.select("#" + tmpName + "Legend").style("opacity", "1"); 
    
          resizePanels();
        }).attr("src", "https://ecosheds.org/geoserver/wms?REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&WIDTH=30&HEIGHT=30&LAYER=birds:" + tmpName);

        d3.select("#" + tmpName + "Legend")
          .append("input")
          .attr({type: "range", name: "layer", min: 0, max: 100, value: 100})
          .attr("id", tmpName + "LegendSlider")
          .property("title", tmpTitle + " Layer Opacity: 100%")
          .on("input", function() { layerOpacity(this, tmpLayer); });

        d3.select("#" + tmpName + "Legend")
          .append("p")
          .attr("class", "legendTrans")
          .text("Transparency");

        d3.select("#legendDefault").style("display", "none");

        d3.select("#legendImgDiv")
          .style("display", "block");
        
        if(legendDivs.length > 1) {
          d3.select("#legendPrev").style("visibility", "visible");
          d3.select("#legendNext").style("visibility", "hidden");
        }

        if(d3.select("#legendDiv").style("opacity") == 0) {
          toolWindowToggle("legend");
        }
      }







      //******Removes images to the legend
      function remLegendImg(tmpName) {
        var tmpBi = 0;
        if(d3.select("#" + tmpName + "Legend").style("display") == "block") {
          tmpBi = 1;
        }

        d3.select("#" + tmpName + "Legend").remove();
        legendDivs.splice(legendDivs.indexOf(tmpName),1);

        //***If removing active legend display the first legend
        if(tmpBi == 1 && legendDivs.length > 0) {
          d3.select("#" + legendDivs[0] + "Legend").style("display", "block");
          var keys = d3.select("#" + legendDivs[0] + "Legend").attr("value").split(",");
          if(keys.length == 2) {
            layerNames[keys[0]][keys[1]].bringToFront();
          }
          else {
            layerNames[keys[0]][keys[1]][keys[2]].bringToFront();
          }
        }

        //***Set div and arrow visibility based on number of legends left
        if(legendDivs.length == 0) {
          d3.select("#legendImgDiv").style("display", "none");
          d3.select("#legendDefault").style("display", "block");
        }
        else if(legendDivs.length == 1) {
          d3.selectAll("#legendPrev,#legendNext").style("visibility", "hidden");
        }
        else if(legendDivs.length == 2) {
          if(d3.select("#" + legendDivs[0] + "Legend").style("display") == "block") {
            d3.select("#legendPrev").style("visibility", "hidden");
            d3.select("#legendNext").style("visibility", "visible");
          }
          else {
            d3.select("#legendPrev").style("visibility", "visible");
            d3.select("#legendNext").style("visibility", "hidden");
          }
        }
        else {
          var tmpLegends = d3.selectAll(".layerLegend")[0];
          if(d3.select(tmpLegends[0]).style("display") == "block") {
            d3.select("#legendPrev").style("visibility", "hidden");
            d3.select("#legendNext").style("visibility", "visible");
          }
          else if(d3.select(tmpLegends[tmpLegends.length - 1]).style("display") == "block") {
            d3.select("#legendPrev").style("visibility", "visible");
            d3.select("#legendNext").style("visibility", "hidden");
          }
          else {            
            d3.selectAll("#legendPrev,#legendNext").style("visibility", "visible");
          }
        } 
      }





      //******Change current legend div
      function changeLegend(tmpDir) {
        var tmpBi = 0;
        legendDivs.some(function(tmpName,i) {
          if(d3.select("#" + tmpName + "Legend").style("display") == "block") {
            tmpBi = 1;
            d3.selectAll(".layerLegend").style("display", "none");
            if(tmpDir == "prev") {
              d3.select("#" + legendDivs[i-1] + "Legend").style("display", "block");
                var keys = d3.select("#" + legendDivs[i-1] + "Legend").attr("value").split(",");
                if(keys.length == 2) {
                  layerNames[keys[0]][keys[1]].bringToFront();
                }
                else {
                  layerNames[keys[0]][keys[1]][keys[2]].bringToFront();
                }
            }
            else {
              d3.select("#" + legendDivs[i+1] + "Legend").style("display", "block");
                var keys = d3.select("#" + legendDivs[i+1] + "Legend").attr("value").split(",");
                if(keys.length == 2) {
                  layerNames[keys[0]][keys[1]].bringToFront();
                }
                else {
                  layerNames[keys[0]][keys[1]][keys[2]].bringToFront();
                }
            }
          }
          return tmpBi == 1;
        });

        tmpBi = 0;
        legendDivs.some(function(tmpName,i) {
          if(d3.select("#" + tmpName + "Legend").style("display") == "block") {
            tmpBi = 1;
            if(i == 0) {
              d3.select("#legendPrev").style("visibility", "hidden");
              d3.select("#legendNext").style("visibility", "visible");
            }
            else if(i == (legendDivs.length - 1)) {
              d3.select("#legendPrev").style("visibility", "visible");
              d3.select("#legendNext").style("visibility", "hidden");
            }
            else {
              d3.select("#legendPrev").style("visibility", "visible");
              d3.select("#legendNext").style("visibility", "visible");
            }
          }
          return tmpBi == 1;
        });
        states2.bringToFront();
      }
        






      //******Make div for legend
      d3.select("body")
        .append("div")
        .attr("class", "legend gradDown")
        .attr("id", "legendDiv");

      $('#legendDiv').draggable({containment: "html", cancel: ".toggle-group,input,textarea,button,select,option"});

      d3.select("#legendDiv")
        .append("h4")
        .text("Legend")
        .attr("class", "legTitle")
        .attr("id", "legendTitle")
        .append("span")
        .html('<span class="glyphicon glyphicon-info-sign help-tooltip" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Legend</center></b></u></p><p>Displays legends for regional occupancy layers added to the map enabling their interpretation along with control over their transparency.</p>"</span>');
 
      d3.select("#legendTitle")
        .append("span")
        .attr("class", "glyphicon glyphicon-remove pull-right minimize-button")
        .property("title", "Click to hide Layers window")
        .on("click", function() { toolWindowToggle("legend"); });

      d3.select("#legendDiv")
        .append("div")
        .attr("id", "legendDefault")
        .text("Add a map layer to view its legend...");

      d3.select("#legendDiv")
        .append("div")
        .attr("id", "legendImgDiv")
        .html('<span id="legendPrev" class="glyphicon glyphicon-menu-left pull-left" title="View previous legend" onclick="changeLegend(\'prev\')"></span><span id="legendNext" class="glyphicon glyphicon-menu-right pull-right" title="View next legend" onclick="changeLegend(\'next\')"></span>');





      //******Change transparency of current legend layer
      function layerOpacity(tmpSlider, tmpLayer) {
        var tmpOpacity = tmpSlider.value/100; 
        tmpSlider.title = "Opacity: " + tmpSlider.value + "%"; 
        tmpLayer.setOpacity(tmpOpacity);
      } 








      //******Make splash screen
      d3.select("body")
        .append("div")
        .attr("id","splashScreen")
        .attr("class", "msgBackgroundDiv")
        .append("div")
        .attr("id", "splashScreenDiv")
        .append("p")
        .attr("id", "splashWelcome")
        .html('Welcome to the <span style="font-variant:small-caps;color:#b3d9ff;font-size:41px;text-shadow:1px 2px black;">Predictor of Avian Communites Tool</span>');

      d3.select("#splashScreenDiv")
        .append("p")
        .html('This tool returns occupancy probabilities and Partners in Flight scores for 21 species of shrubland birds based on the location and area of added management openings. Additionally, a conservation value is calculated for each management opening enabling direct comparison between multiple opening design scenarios.')
        .style({"font-size":"20px","margin":"10px 0px"}); 

      d3.select("#splashScreenDiv")
        .append("p")
        .html('To begin, add a management opening to your area of interest!')
        .style({"font-size":"22px","margin":"0px 10px 10px 20px","text-align":"center","color":"#434d70"});

      d3.select("#splashScreenDiv")
        .append("div")
        .attr("id", "splashGIF")
        .property("title", "Animation showing management opening creation")
        .html('<img src="images/pact_demo.gif" style="position:relative;left:-11px;width:104%">');

      d3.select("#splashScreenDiv")
        .append("button")
        .attr("id", "splashButton")
        .attr("class", "btn legendBtn")
        .property("title", "Click to continue to tool")
        .text("Continue...")
        .on("click", function() { 
          d3.select("#splashScreen").style("display", "none");
          localStorage.setItem('disableSplash', d3.select("#disableSplash").property("checked"));
          //if(localStorage.getItem('doneTour') != "yeah!" && disableTutorialSession != true) {
          //  startIntro();
          //}
          //else {
          //  $('#attrSelectModal').modal('show');
          //}
        });
          

      d3.select("#splashScreenDiv")
        .append("div")
        .style({"float":"right","position":"relative","top":"-50px","left":"-10px"})
        .append("label")
        .property("title", "Check box to prevent this screen from displaying on future website visits")
        .html('<input type="checkbox" id="disableSplash" style="transform:scale(1.3);margin-right:5px;position:relative;top:2px;">Check to prevent this screen from displaying again</input>');







      //*****Make div for downloads
      d3.select("body")
        .append("div")
        .attr("class", "legend gradDown")
        .attr("id", "downloadDiv");

      $('#downloadDiv').draggable({containment: "html", cancel: "input,label,textarea,button,select,option"});

      d3.select("#downloadDiv")
        .append("h4")
        .text("Downloads")
        .attr("class", "legTitle")
        .attr("id", "downloadTitle")
        .append("span")
        .html('<span class="glyphicon glyphicon-info-sign help-tooltip" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Data Download</center></b></u></p><p>Download zip files containing a GeoTIFF of a species regional occupancy probability developed by either Jon Atwood and Mass Audubon (alder flycatcher & chestnut-sided warbler) or Steve Matthews (all other species).</p>"></span>');
 
      d3.select("#downloadTitle")
        .append("span")
        .attr("class", "glyphicon glyphicon-remove pull-right minimize-button")
        .property("title", "Click to hide Downloads window")
        .on("click", function() { toolWindowToggle("download"); });

      d3.select("#downloadDiv")
        .append("div")
        .attr("id", "dlOptions")
        .append("select")
        .attr("id", "dlSelect")
        .attr("class", "shapeUnit")
        .style({"width":"calc(100% - 10px)","font-style":"italic"})
        .property("title", "Select the format of the output file")
        .on("mousedown", function() {  d3.select(this).style("font-style", "normal").select("option").style("display", "none"); })
        .on("change", function() { d3.select(".legendBtn.inactive").classed("inactive", false); d3.select("#dlButton").property("href", "zips/" + this.options[this.selectedIndex].value + ".zip"); });

      var optData = birdID.slice(0);
      optData.splice(0,0, "selectAttr");
      var optTitles = birdTitles.slice(0);
      optTitles.splice(0,0, "Select Layer...");

      d3.select("#dlSelect").selectAll("option")
        .data(optData)
        .enter()
          .append("option")
          .attr("value", function(d) { return d; })
          .property("disabled", function(d, i) { if(i==0) {return "disabled";} })
          .text(function(d,i) { return optTitles[i]; });

      d3.select("#downloadDiv")
        .append("div")
        .attr("class", "legendBtn inactive")
        .html('<a id="dlButton" href="#" title="Download the above layer"><span class="glyphicon glyphicon-download-alt" style="color:white;margin:0;margin-right:5px;opacity:1;"></span>Download</a>');






      //*****Make div for drawing & measuring
      d3.select("body")
        .append("div")
        .attr("class", "legend gradDown")
        .attr("id", "drawDiv");

      $('#drawDiv').draggable({containment: "html", cancel: "input,label,textarea,button,select,option,#enableDraw,#enableImport"});

      d3.select("#drawDiv")
        .append("h4")
        .text("Add Management Opening")
        .attr("class", "legTitle")
        .attr("id", "drawTitle")
        .append("span")
        .html('<span class="glyphicon glyphicon-info-sign help-tooltip" style="margin-left:5px;" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Add Management Opening</center></b></u></p><p>A management opening can be added to the map by either drawing it by hand or importing it from a file. Once added, the shape of the opening may be changed at any time by using the edit tool. Only one opening may exist at a time, so to add a new opening simply delete the current one.</p>"></span>');
 
      d3.select("#drawTitle")
        .append("span")
        .attr("class", "glyphicon glyphicon-remove pull-right minimize-button")
        .style("margin-left", "5px")
        .property("title", "Click to hide Add Management Opening window")
        .on("click", function() { toolWindowToggle("draw"); });

      //***Add draw/import div
      d3.select("#drawDiv")
        .append("div")
        .attr("id", "drawSourceDiv")
        .append("div")
        .attr("id", "enableDraw")
        .property("title", "Add management opening by drawing on the map")
        .style("margin-right", "20px")
        .on("click", function() { 
          d3.select("#drawSourceDiv").selectAll("div").classed("inactive", true);
          d3.select(this).classed("inactive", false);
          d3.select("#drawImport").style("display", "none");
          d3.select("#drawToolbar").style("display", "block");
        })
        .html('<span class="glyphicon glyphicon-pencil"></span><p>Draw</p>');

      d3.select("#drawSourceDiv")
        .append("div")
        .attr("id", "enableImport")
        .property("title", "Add management opening by importing a shapefile or geojson feature")
        .style("margin-left", "20px")
        .classed("inactive", true)
        .on("click", function() { 
          d3.select("#drawSourceDiv").selectAll("div").classed("inactive", true);
          d3.select(this).classed("inactive", false);
          d3.select("#drawToolbar").style("display", "none");
          d3.select("#drawImport").style("display", "block");
        })
        .html('<span class="glyphicon glyphicon-import"></span><p>Import</p>');
      
      //***Add Leaflet Draw toolbar
      d3.select("#drawDiv")
        .append("div")
        .attr("id", "drawCreateDiv")
        .append("div")
        .attr("id", "drawToolbar")
        .html('<label style="margin-bottom:0;" title="Use the below tools to draw a management opening on the map">Draw Management Opening</label><span class="glyphicon glyphicon-info-sign help-tooltip" style="margin-left:10px;" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="" data-original-title="<p><u><b><center>Draw Opening</center></b></u></p><p>Draw, edit, and delete management openings using the icons below.</p>"></span><br>');

      document.getElementById("drawToolbar").appendChild(drawControl.onAdd(map));
      
      //***Add import file div
      d3.select("#drawCreateDiv")
        .append("div")
        .attr("id", "drawImport")
        .html('<input type="file" id="importFile" name="opening" accept=".shp" onchange="checkImport(event)"></input>' 
          + '<label style="margin-right:20px;">Format:</label><label><input type="radio" id="importFileShape" class="importRadio" name="importFileType" checked><span style="margin-right:20px;">Shapefile</span></label><label><input type="radio" id="importFileGeo" class="importRadio" name="importFileType"><span>GeoJSON</span></label>'
          + '<div id="importFileButton" class="inactive legendBtn" onclick="importFile()" title="Click to import the geographic feature in the chosen file"><span class="glyphicon glyphicon-import" style="color:white;margin:0;margin-right:5px;padding:3px;opacity:1;"></span>Import File</div>'
        );

      d3.select("#importFile").on("click", function() { d3.select("#importErrorDiv").style("display", "none"); });


      //***Change file open extension filter
      d3.selectAll("#importFileShape,#importFileGeo")
        .on("click", function() { 
          if(this.id == "importFileShape") {
            d3.select("#importFile").attr("accept", ".shp");
          }
          else {
            d3.select("#importFile").attr("accept", "");
          }
          d3.select("#importFile").property("value", "");
        });

      //***Add Leaflet Measure Tool
      d3.select("#drawDiv")
        .append("div")
        .attr("id", "drawMeasureDiv")
        .append("div")
        .attr("id", "measureTool")
        .html('<label style="display:block;margin-bottom:0;">Large Opening within 3 km<span class="glyphicon glyphicon-info-sign help-tooltip" style="margin-left:10px;" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="" data-original-title="<p><u><b><center>Source Opening</center></b></u></p><p style=&#34;text-align:left;&#34;>Presence of large patch of shrubland:</p><ul style=&#34;text-align:left;&#34;><li>Clearcuts > 5 ha</li><li>Powerline corridors > 50 m wide</li></ul><p style=&#34;text-align:left;&#34;>within 3 km of management opening<br><br>To measure the distance to, or area of an opening, select Yes and use the below measurement tools.</p>"></span></label>'
          + '<label title="There is a source opening within 3 kilometers of this management opening"><input type="radio" id="sourcePopYes" class="importRadio" name="sourcePop" value="yes"><span style="margin-right:70px;">Yes</span></label><label title="There is not a source opening within 3 kilometers of this management opening"><input type="radio" id="sourcePopNo" class="importRadio" name="sourcePop" value="no" checked><span>No</span></label>'
          + '<div id="measureMetricDiv">'
            + '<label style="display:block;margin-bottom:0;">Measure Large Opening</label>'
          + '</div>'
        );

      //***Add click event to large opening question
      d3.selectAll("#sourcePopYes,#sourcePopNo").on("click", function() { 
        if(document.querySelector('input[name=sourcePop]:checked').id == "sourcePopYes") {
          d3.select("#measureMetricDiv").classed("inactive", false);
        }
        else {
          measureDrawControl._toolbars.draw.disable();
          //measureDrawControl._toolbars.edit.disable();
          d3.select("#measureMetricDiv").classed("inactive", true);
        }
      });

      //var measureTool = new L.Control.measureControl();
      //document.getElementById("measureTool").appendChild(measureTool.onAdd(map));

      var measureItems = new L.FeatureGroup();
      map.addLayer(measureItems);

      var measureDrawControl = new L.Control.Draw({
      	draw: {
          position: 'topleft',
          polygon: {allowIntersection: false, drawError: {color: '#b00b00', timeout: 1500}, shapeOptions: {color: '#0066ff'}, showArea: true, metric: ['ha']},
          rectangle: {shapeOptions: {color: '#0066ff'}, showArea: true, metric: ['ha']},
          circle: false,
          //circle: {shapeOptions: {color: '#0066ff'}, showArea: true},
          polyline: {shapeOptions: {color: '#0066ff'}},
          marker: false,
          circlemarker: false
      	},
      	edit: false
        //{
          //featureGroup: measureItems,
          //edit: {selectedPathOptions: {maintainColor: true, opacity: 1, fillOpacity: 0.2}},
          //poly: {allowIntersection: false, drawError: {color: '#b00b00', timout: 1500}}
      	//}
      });
      document.getElementById("measureMetricDiv").appendChild(measureDrawControl.onAdd(map));

      //***Add area and distance inputs
      d3.select("#measureMetricDiv")
        .append("div")
        .attr("id", "openSourceMetrics")
        .html('<label title="The distance in meters (m) of the source opening located within 3 kilometers of your management opening"><span>Distance (m)</span><input type="text" id="openSourceDist"></input>');

      d3.select("#openSourceDist").on("focus", function() { d3.select("#alertDiv").style("display", "none"); });




      //******Ensure a file was selected for import
      function checkImport(event) {
        var input = event.target;
        if(input.files.length > 0) {
          d3.select("#importFileButton").classed("inactive", false);
        }
        else {
          d3.select("#importFileButton").classed("inactive", true);
        }
      }



      //*****Import the file
      function importFile() {
        var file = d3.select("#importFile")[0][0].files[0];
        var reader = new FileReader();
        var tmpJSON;

        if(document.querySelector('input[name=importFileType]:checked').id == "importFileGeo") {
          reader.readAsText(file, 'UTF-8');
          reader.onload = function(event) {
            try {
              var tmpJSON = JSON.parse(event.target.result);
              if((tmpJSON.hasOwnProperty("type") && tmpJSON.hasOwnProperty("features")) || (tmpJSON.hasOwnProperty("type") && tmpJSON.hasOwnProperty("geometry"))) {
                addOpening(tmpJSON, "geo");
              }
              else {
                d3.select("#importErrorDiv").select("p").html('A problem was encountered importing the selected geoJSON. Please ensure that the file is in the correct <a href="http://geojson.org/" target="_blank" style="font-weight:bold;color:blue;" title="geojson.org">format</a>.');
                d3.select("#importErrorDiv").style("display", "block");
              }
            }
            catch(err) {
              d3.select("#importErrorDiv").select("p").html('A problem was encountered importing the selected geoJSON. Please ensure that the file is in the correct <a href="http://geojson.org/" target="_blank" style="font-weight:bold;color:blue;" title="geojson.org">format</a>.');
              d3.select("#importErrorDiv").style("display", "block");
            }
          }
        }
        else {
          reader.addEventListener("loadend", function () {
            shapefile.read(reader.result)
              .then(
                function(collection) {
                  if(collection.bbox[0] < -180 || collection.bbox[0] > 180 || collection.bbox[2] < -180 || collection.bbox[2] > 180 || collection.bbox[1] < -90 || collection.bbox[1] > 90 || collection.bbox[3] < -90 || collection.bbox[3] > 90) {
                    d3.select("#importErrorDiv").select("p").html('A problem was encountered importing the selected shapefile. Please ensure that the layer uses a <a href="https://epsg.io/4326" target="_blank" style="font-weight:bold;color:blue;" title="epsg.io/4326">WGS84</a> coordinate system.');
                    d3.select("#importErrorDiv").style("display", "block");
                  }
                  else {
                    addOpening(collection.features[0], "shape");
                  }
                }
              )
              .catch(
                function(error) {
                  console.log(error.stack);
                }
              );
          });
          reader.readAsArrayBuffer(file);
        }
      }





      //******add imported opening to map as svg
      function addOpening(tmpJSON, tmpType) {
        var tmpOpening = L.geoJson(tmpJSON, {style: {color: '#ff33cc'}}); 
        tmpOpening.eachLayer(function(d) { drawnItems.addLayer(d); });
        d3.select("#drawToolbar").select(".leaflet-draw-actions").style("display", "block");
        map.fireEvent("draw:created", {layerType: "polygon", layer: drawnItems.getLayer(d3.keys(drawnItems._layers)[0])});
        d3.select("#drawToolbar").select(".leaflet-draw-actions").style("display", "none");
        $("#enableDraw").click();
        var tmpCoords = drawnItems.getBounds();
        map.fitBounds([[tmpCoords._northEast.lat, tmpCoords._northEast.lng],[tmpCoords._southWest.lat, tmpCoords._southWest.lng]]);
      }




      //***Add basal area input
      d3.select("#drawDiv")
        .append("div")
        .attr("id", "drawBasalDiv")
        .append("div")
        .attr("id", "basalTool")
        .html('<label style="display:block;margin-bottom:0;">Basal area within opening<span class="glyphicon glyphicon-info-sign help-tooltip" style="margin-left:10px;" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="" data-original-title="<p><u><b><center>Basal Area</center></b></u></p><p style=&#34;text-align:left;&#34;>The average amount of an area occupied by tree stems. It is defined as the total cross-sectional area of all stems in a stand measured at breast height. Basal Area is expressed as either per unit of land area:</p><ul style=&#34;text-align:left;&#34;><li>Square meters per hectare (M^2/HA)</li><li>Square feet per acre (FT^2/AC)</li></ul><p style=&#34;text-align:left;&#34;>or as a percentage:</p><ul style=&#34;text-align:left;&#34;><li>Percent forest retained &nbsp; (% Forest)</li></ul>"></span></label>'
            + '<label title="The basal area of your management opening in the units selected"><span></span><input type="text" id="basalArea" value=0.000></input><select id="basalAreaUnits" class="shapeUnit"></select></label>'
          + '</div>'
        );

      var basalUnits = d3.select("#basalAreaUnits")
        .attr("name", "M^2/HA")
        .property("title", "Square meters per hectare")
        .on("change", function() { changeUnits("% Forest", this.value, d3.select("#basalArea").attr("data-msph"), "basal"); d3.select(this).property("title", tmpTitle[this.selectedIndex]); });

      d3.select("#basalArea")
        .attr("data-msph", basalArea2percForRet(0))
        .on("blur", function() { checkBasal(this.value); });

      var tmpUnits = ["M^2/HA", "FT^2/AC", "% Forest"];
      var tmpTitle = ["Square meters per hectare", "Square feet per acre"];
      basalUnits.selectAll("option")
        .data(tmpUnits)
        .enter()
          .append("option")
            .attr("value", function(d) { return d; })
            .property("title", function(d,i) { return tmpTitle[i]; })
            .text(function(d) {return d; });

      basalUnits.property("selectedIndex", 0);


      function checkBasal(tmpVal) {
        if(isNaN(tmpVal) == true) {
          document.getElementById("basalArea").focus();
        }
        else {
          if(document.getElementById("basalAreaUnits").value == "M^2/HA") {
            d3.select("#basalArea").attr("data-msph", basalArea2percForRet(parseFloat(tmpVal)));
          }
          else if(document.getElementById("basalAreaUnits").value == "FT^2/AC") {
            d3.select("#basalArea").attr("data-msph", basalArea2percForRet(parseFloat(tmpVal/4.356)));
          }
          else {
            d3.select("#basalArea").attr("data-msph", parseFloat(tmpVal)/100);
          }
          d3.select("#basalArea").property("value", parseFloat(tmpVal).toFixed(3));
        }
      }






      //***Add time since treatment input
      d3.select("#drawDiv")
        .append("div")
        .attr("id", "drawTSTDiv")
        .append("div")
        .attr("id", "tstTool")
        .html('<label style="display:block;margin-bottom:0;">Elapsed time<span class="glyphicon glyphicon-info-sign help-tooltip" style="margin-left:10px;" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="" data-original-title="<p><u><b><center>Time Since Treatment</center></b></u></p><p>The length of time that has passed since the opening was created.<br><br>Units are in half-year intervals, for example 3.5 would specify that three and a half years have passed since the treatment was performed.<br><br>The initial value defaults to 6 years as this was the mean time for study sites in Roberts and King (2017).</p>"></span></label>'
            + '<label title="The length of time in years that has elapsed since the treatment was applied to create the opening"><span></span><input type="number" step="0.5" min="0" max="20" id="tstTime" value=6.0></input></label>'
          + '</div>'
        );

      d3.select("#tstTime")
        .attr("data-tst", function() { parseFloat(this.value); })
        //.on("change", function() { checkTST(this.value); })
        .on("blur", function() { checkTST(this.value); });


      function checkTST(tmpVal) {
        if(isNaN(tmpVal) == true) {
          document.getElementById("tstTime").focus();
        }
        else {
          if(tmpVal > 20) {
            tmpVal = 20;
          }
          else if(tmpVal < 0) {
            tmpVal = 0;
          }
          d3.select("#tstTime").property("value", (Math.round(tmpVal*2)/2).toFixed(1));
        }
      }










      //******Add in edge and area text boxes, and unit selector
      d3.select("#drawDiv")
        .append("div")
        .attr("id", "shapeDiv")
        .append("div")
        .attr("id", "edgeDiv")
        .attr("class", "shape")
        .append("p")
        .attr("class", "shapeTitle")
        .text("Opening Perimeter")
        .property("title", "Length of the management opening perimeter");


      d3.select("#shapeDiv")
        .append("div")
        .attr("id", "areaDiv")
        .attr("class", "shape")
        .append("p")
        .attr("class", "shapeTitle")
        .text("Opening Area")
        .property("title", "Area of the management opening");

      d3.select("#edgeDiv")
        .append("input")
        .attr({type: "text"})
        .attr("id", "edgeText")
        .attr("class", "shapeVals")
        .attr("disabled", true)
        .property("title", "Length of the management opening perimeter");

      d3.select("#areaDiv")
        .append("input")
        .attr({type: "text"})
        .attr("id", "areaText")
        .attr("class", "shapeVals")
        .attr("disabled", true)
        .property("title", "Area of the management opening");

      var selectEdge = d3.select("#edgeDiv")
        .append("select")
        .attr("id", "edgeUnit")
        .attr("name", "Meters")
        .attr("class", "shapeUnit")
        .property("title", "Select units for edge value")
        .on("change", function() { changeUnits("Meters", this.value, d3.select("#edgeText").attr("data-m"), "edge") });

      var tmpUnits = ["Meters", "Kilometers", "Feet", "Miles"];
      selectEdge.selectAll("option")
        .data(tmpUnits)
        .enter()
          .append("option")
            .attr("value", function(d) { return d; })
            .text(function(d) {return d; });

      selectEdge.property("selectedIndex", 1);

      var selectArea = d3.select("#areaDiv")
        .append("select")
        .attr("id", "areaUnit")
        .attr("name", "Square Meters")
        .attr("class", "shapeUnit")
        .property("title", "Select units for area value")
        .on("change", function() { changeUnits("Square Meters", this.value, d3.select("#areaText").attr("data-sq_m"), "area") });

      var tmpUnits = ["Square Meters", "Hectares", "Square Kilometers", "Square Feet", "Acres", "Square Miles"];
      selectArea.selectAll("option")
        .data(tmpUnits)
        .enter()
          .append("option")
            .attr("value", function(d) { return d; })
            .text(function(d) {return d; });

      selectArea.property("selectedIndex", 1);





      //Format edge and area values by selected unit
      function changeUnits(oldUnit, unit, val, type) {
        switch (unit) {
          case "Meters":
            var newVal = (val/1);
            break;
          case "Kilometers":
            var newVal = (val/1000);
            break;
          case "Feet":
            var newVal = (val*3.2808);
            break;
          case "Miles":
            var newVal = (val*0.00062137);
            break;
          case "Square Meters":
            var newVal = (val/1);
            break;
          case "Hectares":
            var newVal = (val/10000);
            break;
          case "Square Kilometers":
            var newVal = (val/1000000);
            break;
          case "Square Feet":
            var newVal = (val*10.764);
            break;
          case "Acres":
            var newVal = (val*0.00024711);
            break;
          case "Square Miles":
            var newVal = (val*0.00000038610216);
            break;
          case "M^2/HA":
            var newVal = percForRet2basalArea(val);
            break;
          case "FT^2/AC":
            var newVal = percForRet2basalArea(val)*4.356;
            break;
          case "% Forest":
            var newVal = (val*100);
            break;
        }

        if (type == "edge") {
          d3.select("#edgeText").attr("value", newVal.toFixed(3));
          d3.select("#edgeUnit").attr("name", unit);
        }
        else if(type == "area") {
          d3.select("#areaText").attr("value", newVal.toFixed(3));
          d3.select("#areaUnit").attr("name", unit);
        }
        else if(type == "basal") {
          if(unit == "% Forest" && newVal > 100) {
            d3.select("#basalArea").property("value", "100.000");
          }
          else {
            d3.select("#basalArea").property("value", newVal.toFixed(3));
          }
          d3.select("#basalAreaUnits").attr("name", unit);
        }
      }      

      d3.select("#drawDiv")
        .append("div")
        .attr("id", "hcRunDiv")
        .attr("class", "hcPanelDivs layerList inactive")
        .property("title", "Click to retrieve species' occupancy probabilities for the management opening")
        .html('<span class="glyphicon glyphicon-play"></span><p>Analyze</p>')
        .on("click", function() { 
          if((document.querySelector('input[name=sourcePop]:checked').value == "yes" && isNaN(parseInt(d3.select("#openSourceDist").property("value"))) == false) || document.querySelector('input[name=sourcePop]:checked').value == "no") {
            d3.select("#waitingDiv").style("display", "block");
            d3.select("#graphs").selectAll("div").remove();
            socket.emit("get_bcr", {"geom": drawnItems.toGeoJSON().features[0].geometry});
            setTimeout(function() {
              graphSpp.forEach(function(spp) { addGraphs(spp); });
            }, 1000);
          }
          else {
            d3.select("#alertDiv").style("display", "block");
          }
        });

      



      //*****Make div for exporting management opening
      d3.select("body")
        .append("div")
        .attr("class", "legend gradDown")
        .attr("id", "exportDiv");

      $('#exportDiv').draggable({containment: "html", cancel: "input,label,textarea,button,select,option"});

      d3.select("#exportDiv")
        .append("h4")
        .text("Export Management Opening")
        .attr("class", "legTitle")
        .attr("id", "exportTitle")
        .append("span")
        .html('<span class="glyphicon glyphicon-info-sign help-tooltip" style="margin-left:5px;" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Export Management Opening</center></b></u></p><p>Export the current management opening in either shapefile or geoJSON format.</p>"></span>');
 
      d3.select("#exportTitle")
        .append("span")
        .attr("class", "glyphicon glyphicon-remove pull-right minimize-button")
        .style("margin-left", "5px")
        .property("title", "Click to hide Export window")
        .on("click", function() { toolWindowToggle("export"); });

      d3.select("#exportDiv")
        .append("div")
        .attr("id", "exportViewDiv")
        .append("div")
        .attr("id", "exportDefaultDiv")
        .html('<p style="margin:0;"><i>Create a management opening to enable its export to either a shapefile or geoJSON</i></p>');

      d3.select("#exportViewDiv")
        .append("div")
        .attr("id", "exportActualDiv")
        .html(''
          + '<label>Select the format for the exported file</label>'
          + '<label title="Export management opening to a shapefile format"><input type="radio" id="exportShape" class="exportRadio" name="exportFormat" value="shapefile" checked><span style="margin-right:35px;">Shapefile</span></label><label title="Export management opening to a geoJSON file"><input type="radio" id="exportGeo" class="exportRadio" name="exportFormat" value="geojson"><span style="margin-right:0px;">GeoJSON</span></label>'
          + '<div id="exportFileButton" class="legendBtn" title="Click to export the management opening to a file in the selected format"><a id="exportFileButtonA" href="#"><span class="glyphicon glyphicon-export" style="color:lime;margin:0;margin-right:5px;opacity:1;"></span>Export File</a></div>'
        );

      d3.selectAll("#exportShape,#exportGeo").on("change", function() { console.log(this.id); setExport(); });








      //*****Make div for viewing results
      d3.select("body")
        .append("div")
        .attr("class", "legend gradDown")
        .attr("id", "resultsDiv");

      $('#resultsDiv').draggable({containment: "html", cancel: "input,label,textarea,button,select,option"});

      d3.select("#resultsDiv")
        .append("h4")
        .text("Analysis Results")
        .attr("class", "legTitle")
        .attr("id", "resultsTitle")
        .append("span")
        .html('<span class="glyphicon glyphicon-info-sign help-tooltip" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Results</center></b></u></p><p>Reports occupancy probability for each species.<br><br>Regional occupancy reports the mean occupancy value of the current management opening queried from species occupancy rasters developed by either Jon Atwood and Mass Audubon (alder flycatcher & chestnut-sided warbler) or Steve Matthews (all other species).<br><br>Habitat occupancy is calculated for each species by multiplying the probabilites for the size of the management opening, the basal area of remaining trees in the opening, and the time since the opening was created.<br><br>Local occupancy is the product of Regional and Habitat occupancies.<br><br>PIF Score is the Partners in Flight regional concern score for breeding birds (RCS-b) available at pif.birdconservancy.org/ ACAD/Database.aspx.</p>"></span>');
 
      d3.select("#resultsTitle")
        .append("span")
        .attr("class", "glyphicon glyphicon-remove pull-right minimize-button")
        .property("title", "Click to hide Results window")
        .on("click", function() { toolWindowToggle("results"); });

      d3.select("#resultsDiv")
        .append("div")
        .attr("id", "conValDiv")
        .html(''
          + '<label style="margin-left:5px;" title="Conservation value of management opening">Conservation Value of management opening'
            + '<span class="glyphicon glyphicon-info-sign help-tooltip" style="margin-left:5px;position:relative;top:3px;" data-toggle="tooltip" data-container="body" data-placement="auto top" data-html="true" title="<p><u><b><center>Conservation Value</center></b></u></p><p>Sum of local occupancy times PIF score over all species as described by Equation 1 in Nuttle et al, 2003 (The Auk, 120:1 541-549).</p>"></span>'
            + '<div id="conVal"><p></p><span></span></div>'
          + '</label><br>'
          + '<label style="margin-left:5px;" title="Number of species predicted to inhabit the management opening using a local occupancy probability threshold value of 0.5 or greater">Likely number of species present in opening'
            + '<span class="glyphicon glyphicon-info-sign help-tooltip" style="margin-left:5px;position:relative;top:3px;" data-toggle="tooltip" data-container="body" data-placement="auto top" data-html="true" title="<p><u><b><center>Species Present</center></b></u></p><p>The likely number of species predicted to inhabit the management opening assuming a local occupancy probability threshold of 0.5 or greater.</p>"></span>'
            + '<div id="likelySpp"><p></p><span></span></input>'
          + '</label>'

        );


      d3.select("#resultsDiv")
        .append("div")
        .attr("id", "resultsViewDiv")
        .append("div")
        .attr("id", "resultsDefaultDiv")
        .html('<p style="margin:0;"><i>Create a management opening and click the analysis button to produce results</i></p>');


      d3.select("#resultsViewDiv")
        .append("div")
        .attr("id", "resultsActualDiv")
        .html('<table id="resultsTable"><thead><tr><th title="Common name of bird species">Species</th><th title="Species occupancy probability derived from broad-scale models">Regional Occupancy</th><th title="Species occupancy probability derived from models based on characteristics of the management opening (size, basal area, time since treatment)">Habitat Occupancy</th><th title="The product of the Regional and Habitat occupancy probabilities, and the value used to determine species presence in the management opening">Local Occupancy</th><th title="The Regional Concern Score (breeding season) (RCS-b) value from the Partners In Flight database for the Bird Conservation Region (BCR) in which the opening is located">PIF Score</th><th title="Click to view a species occupancy model distribution graphs">Graphs</th></tr></thead><tbody id="resultsTableBody"></tbody></table>');

      d3.select("#resultsDiv")
        .append("div")
        .style("padding", "0 5px 5px 5px")
        .html('<div id="adjustResults"><div id="adjustArea" class="adjustDiv"><p class="sliderHeading" title="The size of the managment opening">Opening Area</p><span id="areaReset" class="glyphicon glyphicon-refresh sliderReset" title="Reset opening area slider to initial value"></span></div><div id="adjustBasal" class="adjustDiv"><p class="sliderHeading" title="The amount of basal area left in the management opening at the time of its creation">Basal Area</p><span id="basalReset" class="glyphicon glyphicon-refresh sliderReset" title="Reset basal slider to initial value"></span></div><div id="adjustTime" class="adjustDiv"><p  class="sliderHeading" title="The time in years since the management opening was created">Time</p><span id="timeReset" class="glyphicon glyphicon-refresh sliderReset" title="Reset time since treatment slider to initial value"></span></div></div>'
          + '<div id="exportResults" class="legendBtn" title="Click do download analysis results to a CSV file"><a id="exportResultsA" href="#" download="PACT_results.csv"><span class="glyphicon glyphicon-download-alt" style="color:white;margin-right:5px;margin-left:0;opacity:1;"></span>Download Results</a></div>');

      d3.select("#basalReset").on("click", function() { d3.select("#basalSlider").property("value", this.value).property("title", this.value); update_occupancy(d3.select("#basalSlider")[0][0]); });
      d3.select("#timeReset").on("click", function() { d3.select("#timeSlider").property("value", this.value).property("title", this.value); update_occupancy(d3.select("#timeSlider")[0][0]); });
      d3.select("#areaReset").on("click", function() { d3.select("#areaSlider").property("value", this.value).property("title", this.value); update_occupancy(d3.select("#areaSlider")[0][0]); });
     
      d3.select("#adjustArea")
        .append("input")
        .attr({type: "range", name: "Area", min: 0, max: function() { return getAreaMax(); }, step: function() { return getAreaStep(); }, value: "0.000"})
        .attr("id", "areaSlider")
        .on("mouseover", function(data) { showIt(this); })
        .on("mousemove", function() { tooltip.style("top", (d3.event.pageY-50) + "px").style("left", (d3.event.pageX-46) + "px"); })
        .on("mouseout", function() { tooltip.style("visibility", "hidden"); })
        .on("input", function() { update_occupancy(this); });

      d3.select("#adjustArea")
        .append("ul")
        .attr("id", "areaSliderLabels")
        .attr("class", "rangeLabels")
        .html(function() { return getAreaLabels(); });

      d3.select("#adjustArea")
        .append("p")
        .attr("id", "areaSliderTitle")
        .attr("class", "sliderTitle")
        .property("title", function() { return document.getElementById("areaUnit").value; })
        .text(function() { return document.getElementById("areaUnit").value; });


     d3.select("#adjustBasal")
        .append("input")
        .attr({type: "range", name: "Basal", min: function() { return getBasalMinMax("min"); }, max: function() { return getBasalMinMax("max"); }, step: function() { return getBasalStep(); }, value: "0.000"})
        .attr("id", "basalSlider")
        .on("mouseover", function(data) { showIt(this); })
        .on("mousemove", function() { tooltip.style("top", (d3.event.pageY-50) + "px").style("left", (d3.event.pageX-46) + "px"); })
        .on("mouseout", function() { tooltip.style("visibility", "hidden"); })
        .on("input", function() { update_occupancy(this); });

      d3.select("#adjustBasal")
        .append("ul")
        .attr("id", "basalSliderLabels")
        .attr("class", "rangeLabels")
        .html(function() { return getBasalLabels(); });

      d3.select("#adjustBasal")
        .append("p")
        .attr("id", "basalSliderTitle")
        .attr("class", "sliderTitle")
        .text(function() { return getBasalTitle(); });


      d3.select("#adjustTime")
        .append("input")
        .attr({type: "range", name: "Time", min: 0, max: 20, step: 0.5, value: "6.000"})
        .attr("id", "timeSlider")
        .on("mouseover", function(data) { showIt(this); })
        .on("mousemove", function() { tooltip.style("top", (d3.event.pageY-50) + "px").style("left", (d3.event.pageX-46) + "px"); })
        .on("mouseout", function() { tooltip.style("visibility", "hidden"); })
        .on("input", function() { update_occupancy(this); });

      d3.select("#adjustTime")
        .append("ul")
        .attr("id", "timeSliderLabels")
        .attr("class", "rangeLabels")
        //.html('<li>0</li><li>5</li><li>10</li><li>15</li><li>20</li>');
        .html('<li class="first_li">0</li><li>10</li><li class="last_li">20</li>');

      d3.select("#adjustTime")
        .append("p")
        .attr("id", "timeSliderTitle")
        .attr("class", "sliderTitle")
        .property("title", "Years")
        .text("Years");



      //******Get the title for the basal slider using the selected basal input
      function getAreaLabels() {
        switch(document.getElementById("areaUnit").value) {
          case "Square Meters":
            //return '<li>0</li><li>5k</li><li>10k</li><li>15k</li><li>20k</li>';
            return '<li class="first_li">0</li><li>10k</li><li class="last_li">20k</li>';
            break;
          case "Hectares":
            //return '<li>0</li><li>0.5</li><li>1</li><li>1.5</li><li>2</li>';
            return '<li class="first_li">0</li><li>1</li><li class="last_li">2</li>';
            break;
          case "Square Kilometers":
            //return '<li>0</li><li>0.005</li><li>0.01</li><li>0.015</li><li>0.02</li>';
            return '<li class="first_li">0</li><li>0.01</li><li class="last_li">0.02</li>';
            break;
          case "Square Feet":
            //return '<li>0</li><li>53,820</li><li>107,639</li><li>161,459</li><li>215,278</li>';
            //return '<li>0</li><li>54k</li><li>108k</li><li>161k</li><li>215k</li>';
            return '<li class="first_li">0</li><li>108k</li><li class="last_li">215k</li>';
            break;
          case "Acres":
            //return '<li>0</li><li>1.24</li><li>2.47</li><li>3.71</li><li>4.94</li>';
            return '<li class="first_li">0</li><li>2.47</li><li class="last_li">4.94</li>';
            break;
          case "Square Miles":
            //return '<li>0</li><li>0.002</li><li>0.004</li><li>0.006</li><li>0.008</li>';
            return '<li class="first_li">0</li><li>0.004</li><li class="last_li">0.008</li>';
            break;
        }
      }


      //******Get the min and max values for the basal slider using the selected basal input
      function getAreaMax() {
        switch(document.getElementById("areaUnit").value) {
          case "Square Meters":
            return 20000;
            break;
          case "Hectares":
            return 2;
            break;
          case "Square Kilometers":
            return 0.02;
            break;
          case "Square Feet":
            return 215278;
            break;
          case "Acres":
            return 4.9421;
            break;
          case "Square Miles":
            return 0.007722;
            break;
        }
      }

      //******Get the min and max values for the basal slider using the selected basal input
      function getAreaStep() {
        switch(document.getElementById("areaUnit").value) {
          case "Square Meters":
            return 0.001;
            break;
          case "Hectares":
            return 0.001;
            break;
          case "Square Kilometers":
            return 0.00002;
            break;
          case "Square Feet":
            return 0.001;
            break;
          case "Acres":
            return 0.001;
            break;
          case "Square Miles":
            return 0.00000772204;
            break;
        }
      }







      //******Get the title for the basal slider using the selected basal input
      function getBasalLabels() {
        switch(document.getElementById("basalAreaUnits").value) {
          case "M^2/HA":
            //return '<li>' + Math.round(percForRet2basalArea(0)) + '</li><li>' + Math.round(percForRet2basalArea(0.25)) + '</li><li>' + Math.round(percForRet2basalArea(0.5)) + '</li><li>' + Math.round(percForRet2basalArea(0.75)) + '</li><li>' + Math.round(percForRet2basalArea(1)) + '</li>';
            return '<li class="first_li">' + Math.round(percForRet2basalArea(0)) + '</li><li>' + Math.round(percForRet2basalArea(0.5)) + '</li><li class="last_li">' + Math.round(percForRet2basalArea(1)) + '</li>';
            break;
          case "FT^2/AC":
            //return '<li>' + Math.round(percForRet2basalArea(0)*4.356) + '</li><li>' + Math.round(percForRet2basalArea(0.25)*4.356) + '</li><li>' + Math.round(percForRet2basalArea(0.5)*4.356) + '</li><li>' + Math.round(percForRet2basalArea(0.75)*4.356) + '</li><li>' + Math.round(percForRet2basalArea(1)*4.356) + '</li>';
            return '<li class="first_li">' + Math.round(percForRet2basalArea(0)*4.356) + '</li><li>' + Math.round(percForRet2basalArea(0.5)*4.356) + '</li><li class="last_li">' + Math.round(percForRet2basalArea(1)*4.356) + '</li>';
            break;
          case "% Forest":
            //return '<li>0</li><li>25</li><li>50</li><li>75</li><li>100</li>';
            return '<li class="first_li">0</li><li>50</li><li class="last_li">100</li>';
            break;
        }
      }

      //******Get the title for the basal slider using the selected basal input
      function getBasalTitle() {
        switch(document.getElementById("basalAreaUnits").value) {
          case "M^2/HA":
            //return "Square Meters per Hectare";
            d3.select("#basalSliderTitle").property("title", "Square Meters per Hectare");
            return document.getElementById("basalAreaUnits").value;
            break;
          case "FT^2/AC":
            //return "Square Feet per Acre";
            d3.select("#basalSliderTitle").property("title", "Square Feet per Acre");
            return document.getElementById("basalAreaUnits").value;
            break;
          case "% Forest":
            //return "% Forest Retained";
            d3.select("#basalSliderTitle").property("title", "% Forest Retained");
            return document.getElementById("basalAreaUnits").value;
            break;
        }
      }

      //******Get the min and max values for the basal slider using the selected basal input
      function getBasalMinMax(tmpEnd) {
        switch(document.getElementById("basalAreaUnits").value) {
          case "M^2/HA":
            if(tmpEnd == "min") {
              return 0;
            }
            else {
              return percForRet2basalArea(1);
            }
            break;
          case "FT^2/AC":
            if(tmpEnd == "min") {
              return 0;
            }
            else {
              return percForRet2basalArea(1) * 4.356;
            }
            break;
          case "% Forest":
            if(tmpEnd == "min") {
              return 0;
            }
            else {
              return 100;
            }
            break;
        }
      }

      //******Get the title for the basal slider using the selected basal input
      function getBasalStep() {
        switch(document.getElementById("basalAreaUnits").value) {
          case "M^2/HA":
            return 0.001;
            break;
          case "FT^2/AC":
            return 0.001;
            break;
          case "% Forest":
            return 0.001;
            break;
        }
      }






      //*****Make div for songs & photos
      d3.select("body")
        .append("div")
        .attr("class", "legend gradDown")
        .attr("id", "songsDiv");

      $('#songsDiv').draggable({containment: "html", cancel: "input,label,textarea,button,select,option,audio"});

      d3.select("#songsDiv")
        .append("h4")
        .text("Bird Songs & Photos")
        .attr("class", "legTitle")
        .attr("id", "songsTitle")
        .append("span")
        .html('<span class="glyphicon glyphicon-info-sign help-tooltip" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Bird Songs & Photos</center></b></u></p><p>Listen to calls and view images of bird species found in management openings.<br><br>All photos are credited to <b><a href=&quot;http://www.audubon.org/bird-guide&quot; target=&quot;_blank&quot;>Audubon</a></b> (www.audubon.org).<br><br>All songs were acquired through <b><a href=&quot;http://www.xeno-canto.org/&quot; target=&quot;_blank&quot;>Xeno Canto</a></b> (www.xeno-canto.org).</p>"></span>');
 
      d3.select("#songsTitle")
        .append("span")
        .attr("class", "glyphicon glyphicon-remove pull-right minimize-button")
        .property("title", "Click to hide Bird Songs & Photos window")
        .on("click", function() { toolWindowToggle("songs"); });

      //******Add in bird song and pictures
      d3.select("#songsDiv")
        .append("div")
        .attr("id", "songs")
        .append("h4")
        .attr("id", "species")
        .html('<span id="sppCommon" title="Alder Flycatcher">Alder Flycatcher</span><br><span style="color:navy;">(<span id="sppLatin" style="font-style:italic;font-size:14px;" title="Empidonax alnorum">Empidonax alnorum</span>)</span>');

      d3.select("#songs")
        .append("img")
        .attr("id", "birdPic")
        .property("title", "Alder Flycatcher")
        .attr("src", "bird_pics/alder_flycatcher.jpg");

      d3.select("#songs")
        .append("audio")
        .attr("src", "bird_songs/alder_flycatcher.mp3")
        .attr("controls", "controls")
        .attr("id", "birdSong");

      //***Control Volume
      //d3.select("#birdSong").property("volume", 0.5);
      //***Control start/stop
      //d3.select("#birdSong")[0][0].play();
      //d3.select("#birdSong")[0][0].pause();
      //d3.select("#birdSong")[0][0].load();





      //*****Make div for species occupancy graphs
      d3.select("body")
        .append("div")
        .attr("class", "legend gradDown")
        .attr("id", "graphsDiv");

      $('#graphsDiv').draggable({containment: "html", cancel: "input,label,textarea,button,select,option,audio"});

      d3.select("#graphsDiv")
        .append("h4")
        .text("Species Occupancy Plots")
        .attr("class", "legTitle")
        .attr("id", "graphsTitle")
        .append("span")
        .html('<span class="glyphicon glyphicon-info-sign help-tooltip" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Species Occupancy Functions</center></b></u></p><p>Display species occupancy probability plots for opening area, basal area, and time since treatment, along with the habitat occupancy which is the product of all three occupancy predictions.<br>Green points and numbers indicate higher than initial values, red points and numbers indicate lower than initial values.</p>"></span>');
 
      d3.select("#graphsTitle")
        .append("span")
        .attr("class", "glyphicon glyphicon-remove pull-right minimize-button")
        .property("title", "Click to hide Species Occupancy Plots window")
        .on("click", function() { toolWindowToggle("graphs"); });

      //******Add in graph titles
      d3.select("#graphsDiv")
        .append("div")
        .attr("id", "graphTitles")
        .html('<p class="graphTitle">Opening Area</p><p class="graphTitle">Basal Area</p><p class="graphTitle">Time Since Treatment</p>');
      
      //******Add in div for graphs
      d3.select("#graphsDiv")
        .append("div")
        .attr("id", "graphs");






      //******Add species occupancy graphs
      function addGraphs(spp) {
        var i = birdID.indexOf(spp + "_OH");
        d3.select("#graphs")
          .insert("div", ":first-child")
          .attr("id", spp + "Graphs")
          .attr("class", "sppGraphs")
          .append("p")
          .attr("class", "graphSppP")
          .property("title", birdTitles[i])
          .text(birdTitles[i]);

        d3.select("#" + spp + "Graphs")
          .append("span")
          .attr("class", "glyphicon glyphicon-remove pull-right minimize-button remove-spp")
          .property("title", "Click to remove" + birdTitles[i] + " plots")
          .on("click", function() { d3.select("#" + spp + "Graphs").remove(); graphSpp.splice(graphSpp.indexOf(spp),1); });

        
        var margin = {top: 10, right: 10, bottom: 20, left: 30}
        var width = 100;
        var height = 100;

        ["area", "basal", "time"].forEach(function(type) {
          if(type == "area") { 
            var tmpXMax = getAreaMax(); 
          } 
          else if(type == "basal") { 
            var tmpXMax = getBasalMinMax("max"); 
          } 
          else { 
            var tmpXMax = 20; 
          }

          var x = d3.scale.linear()
            .domain([0, tmpXMax])
            .range([0, width]);

          var y = d3.scale.linear()
            .domain([0, 1])
            .range([height, 0]);
 
          //***Add the x and y functions to the birds JSON
          birds.occ[spp].model[type + "X"] = x;
          birds.occ[spp].model[type + "Y"] = y;

          var xAxis = d3.svg.axis().scale(x)
	    .orient("bottom").tickValues([0, tmpXMax/2, tmpXMax]);
 
          var yAxis = d3.svg.axis().scale(y)
	    .orient("left").ticks(3);
 
          var valueline = d3.svg.line()
	    .x(function(d) { return x(d.x); })
	    .y(function(d) { return y(d.y); });

          d3.select("#" + spp + "Graphs")
            .append("div")
            .attr("id", spp + "_" + type + "Div")
            .attr("class", "graphDiv");

          var svg = d3.select("#" + spp + "_" + type + "Div")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
          
          //***get the data
          var data = [];
          var i;
          var n = 100;
          for (i = 0; i < 101; i++) { 
            if(type == "area") {
              var tmpX = getAreaSliderVal((tmpXMax/n)*i);
              var tmpY = openingArea(spp, prawSource, tmpX, openSourceDist);
            }
            else if(type == "basal") {
              var tmpX = getBasalSliderVal((tmpXMax/n)*i);
              var tmpY = basalArea(tmpX, spp);
            }
            else {
              var tmpX = (tmpXMax/n)*i;
              var tmpY = succession(tmpX, spp);
            }
            
            data.push({"x": (tmpXMax/n)*i, "y": tmpY});
          }

          svg.append("path")	
            .attr("class", "line")
            .attr("d", valueline(data));
 
          svg.append("g")  
            .attr("class", "axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis);
 
          svg.append("g")
            .attr("class", "axis")
            .call(yAxis);

          d3.select("#" + spp + "_" + type + "Div")
            .append("p")
            .text(function() { if(type == "area") { return d3.select("#areaSlider").property("name"); } else if(type == "basal") { return d3.select("#basalSlider").property("name"); } else { return "Years"; } });

          d3.select("#" + spp + "Graphs")
            .append("p")
            .attr("class", "graphOp")
            .text(function() { if(type == "area" || type == "basal") { return "X"; } else { return "="; } });

          //***Add in a point for initial values (.point1) and one for adjusted values (.point2)
          if(type == "area") {
            var tmpX = getAreaSliderVal(parseFloat(d3.select("#areaReset").property("value")));
            var tmpY = openingArea(spp, prawSource, tmpX, openSourceDist);
            
            tmpX = parseFloat(d3.select("#areaReset").property("value"));
          }
          else if(type == "basal") {
            var tmpX = getBasalSliderVal(parseFloat(d3.select("#basalReset").property("value")));
            var tmpY = basalArea(tmpX, spp);
            tmpX = parseFloat(d3.select("#basalReset").property("value"));
          }
          else {
            var tmpX = parseFloat(d3.select("#timeReset").property("value"));
            var tmpY = succession(tmpX, spp);
          }

          svg.append("svg:circle")
            .attr("class", 'point2')
            .attr("r", 4)
            .attr("cx", x(tmpX))
            .attr("cy", y(tmpY))
            .append("svg:title")
            .text(tmpX.toFixed(2) + "," + tmpY.toFixed(2));

          svg.append("svg:circle")
            .attr("class", 'point1')
            .attr("r", 4)
            .attr("cx", x(tmpX))
            .attr("cy", y(tmpY))
            .append("svg:title")
            .text(tmpX.toFixed(2) + "," + tmpY.toFixed(2));

        });

        d3.select("#" + spp + "Graphs")
        .append("p")
        .attr("id", spp + "OccP")
        .attr("class", "graphOp habOcc") 
        .property("title", "Habitat Occupancy")
        .text(birds.occ[spp].hab.toFixed(2));

        resizePanels();
      }  








      //******Add in shapefile import error
      d3.select("body")
        .append("div")
        .attr("class", "legend gradDown")
        .attr("id", "importErrorDiv");

      //$('#importErrorDiv').draggable({containment: "html", cancel: "input,label,textarea,button,select,option"});

      d3.select("#importErrorDiv")
        .append("h4")
        .text("Import Error")
        .attr("class", "legTitle")
        .append("span")
        .attr("class", "glyphicon glyphicon-remove pull-right minimize-button")
        .property("title", "Click to close")
        .on("click", function() { d3.select("#importErrorDiv").style("display", "none"); });

      d3.select("#importErrorDiv")
        .append("div")
        .style({"padding":"5px","background":"white","border-radius":"0 0 4px 4px"})
        .append("p");








      //******Add in missing distance div
      d3.select("body")
        .append("div")
        .attr("class", "legend gradDown")
        .attr("id", "alertDiv");

      //$('#alertDiv').draggable({containment: "html", cancel: "input,label,textarea,button,select,option"});

      d3.select("#alertDiv")
        .append("h4")
        .text("Missing Distance")
        .attr("class", "legTitle")
        .append("span")
        .attr("class", "glyphicon glyphicon-remove pull-right minimize-button")
        .property("title", "Click to close")
        .on("click", function() { d3.select("#alertDiv").style("display", "none"); });

      d3.select("#alertDiv")
        .append("div")
        .style({"padding":"5px","background":"white","border-radius":"0 0 4px 4px"})
        .append("p")
        .text("Please add a distance measure between your management opening and the nearest large opening.");






      //*******Make Help/information div
      d3.select("body")
        .append("div")
        .attr("class", "modal fade ui-draggable in")
        .attr("id", "helpDiv")
        .style("display", "none")
        .append("div")
        .attr("class", "modal-dialog modal-lg")
        .attr("id", "infoDiv")
        .append("div")
        .attr("class", "helpTitle")
        .text("PACT: Predictor of Avian Communities Tool")
        .property("title", "PACT: Predictor of Avian Communities Tool informational details")
        .append("span")
        .attr("class", "glyphicon glyphicon-remove pull-right minimize-button")
        .attr("data-toggle", "modal")
        .attr("data-target", "#helpDiv")
        .property("title", "Close window");
        
      d3.select("#infoDiv")
        .append("div")
        .attr("id", "helpMenu")
        .html('<ul class="nav nav-pills nav-stacked"><li class="active" id="overview" title="Project Overview" onclick="changePill(this)"><a href="#">Project Overview</a></li><li id="usage" title="Performance and Design" onclick="changePill(this)"><a href="#">Performance and Design</a></li><li id="videos" title="Instructional Videos" onclick="changePill(this)"><a href="#">Instructional Videos</a></li><li id="sources" title="Data & Calculations" onclick="changePill(this)"><a href="#">Data & Calculations</a></li></ul>');

      d3.select("#infoDiv")
        .append("div")
        .attr("id", "helpContent")
        .append("div")
        .attr("class", "helpDivs")
        .attr("id", "help-overview")
        .style("display", "inline-block") 
        .html('<h3 style="margin-top:5px;">Background</h3>'
           + '<p>As a result of changes in natural and anthropogenic disturbance regimes, the extent of early-successional forest across much of eastern North American is near historic lows and continues to decline. This has caused many managers and researchers to identify the conservation of early-successional species as a high priority. Early-successional "shrubland" bird species require conditions and resources present in recently disturbed sites. Historical disturbance regimes such as windthrow, fire, and flooding have been altered or suppressed in eastern forests through human activity such as conversion of forests to younger aged stands more resistant to wind, fire suppression and mesophication of fire-adapted communities, and suppression of beaver activity and flooding. Furthermore, anthropogenic disturbance has shifted over much of the region to types of land use that provide less shrubland habitat of lower quality than historic levels.</p>'
           + '<h3>Objectives</h3>'
           + '<p>PACT was developed to allow managers and individuals to:</p>'
           + '<ul>'
             + '<li><p>Specify their geographic locality and management footprint</p></li>'
             + '<li><p>Visualize the outputs of habitat management practices</p></li>'
             + '<li><p>Compare different management scenarios in terms of shrubland bird occupancy probability and species composition</p></li>'
           + '</ul>'
           + '<p>PACT has the intended objectives of enabling users to:</p>'
           + '<ul>'
             + '<li><p>Identify practices that are most likely to achieve target goals</p></li>'
             + '<li><p>Identify optimal sites on which to manage for shrubland birds</p></li>'
           + '</ul>'
           + '<br><p>PACT is intended for use in forested landscapes with les than 30% of agricultural and urban development within a mile (1.6 KM) of the project site. A higher percentage of these non-forest cover types in the landscape may increase nest predation and brood parasitism by brown-headed cowbirds (<a href="https://science.sciencemag.org/content/267/5206/1987" target="_blank" title="Robinson, S.K., Thompson III, F.R., Donovan, T.M., Whitehead, D.R., Faaborg, J. (1995) Regional forest fragmentation and the nesting succes of migratory birds. Science, 267(5206):1987-1990.">Robinson et al 1995</a>, <a href="https://www.fs.usda.gov/treesearch/pubs/2898" target="_blank" title="Hunter, W.C., Buehler, D.A., Canterbury, R.A., and Confer, J.L. (2001) Conservation of disturbance-dependent birds in eastern North America. Wildlife Society Bulletin, 29(2):440-455.">Hunter et al 2001</a>, <a href="https://onlinelibrary.wiley.com/doi/full/10.1111/j.1523-1739.2004.00254.x" target="_blank" title="Driscoll, M.J.L., and Donovan, T.M. (2004) Landscape context moderates edge effects: Nesting success of wood thrushes in central New York. Conservation Biology, 18(5):1330-1338.">Driscoll and Donovan 2004</a>).</p>'
           + '<br><p>In its current formulation, PACT is limited to silvicultural operations within New England. Inclusion of shrubland bird species from other regions, and other forms of shrubland habitat management (e.g. mowing or prescribed burns) is anticipated for future versions.</p>'
           + '<h3>Tool Development Team</h3>'
           + '<p><u>US Forest Service, Northern Research Unit</u></p>'
           + '<ul>'
             + '<li><p>Dave King</p></li>'
             + '<li><p>Keith Nislow</p></li>'
           + '</ul>'
           + '<p><u>University of Massachusetts, Amherst</u></p>'
           + '<ul>'
             + '<li><p>Jason Coombs</p></li>'
             + '<li><p>Mike Akresh</p></li>'
           + '</ul>'
           //+ '<p><a href="https://www.nrs.fs.fed.us/atlas/bird/bird_atlas.html" target="_blank" title="www.nrs.fs.fed.us/atlas/bird/">Bird distribution maps</a> generated by <a href="mailto: snmatthews@fs.fed.us?Subject=Distribution%20Maps" title="snmatthews@fs.fed.us">Stephen Matthews</a>.</p>'
           + '<p><u>Bird Distribution Maps</u></p>'
           + '<ul>'
             + '<li>Alder Flycatcher & Chestnut-sided Warbler</li>'
             + '<ul>'
               + '<li>Jon Atwood (<a target="_blank" href="https://www.massaudubon.org/" title="massudubon.org">Mass Audubon</a>)</li>'
             + '</ul>'
             + '<li>All other species</li>'
             + '<ul>'
               + '<li>Stephen Matthews (<a target="_blank" href="https://www.nrs.fs.fed.us/atlas/bird/" title="nrs.fs.fed.us/atlas/bird">Climate Change Bird Atlas</a>)</li>'
             + '</ul>'
           + '</ul>'
           + '<p>Questions or comments should be directed to Jason Coombs at <a href="mailto:jcoombs@cns.umass.edu?Subject=PACT" title="jcoombs@cns.umass.edu">jcoombs@cns.umass.edu</a>.</p>'
         );

      d3.select("#helpContent")
        .append("div")
        .attr("class", "helpDivs")
        .attr("id", "help-usage")
        .html('<h3 style="margin-top:5px;">Overview</h3>'
           + '<p>PACT presents users with a means to quickly and easily assess predicted shrubland avian communities for designed management openings of varying size and differing locations through an intuitive map-based interface.</p>'
           + '<h3>Optimal Performance Requirements</h3>'
           + '<p>PACT is currently supported on the latest versions of all major web browsers, however <a target="_blank" href="https://www.google.com/chrome/" title="www.google.com/chrome">Google Chrome</a> and <a target="_blank" href="https://www.mozilla.org/" title="www.mozilla.org">Mozilla Firefox</a> are highly recommended for the best user experience. PACT is not presently developed for use with mobile devices.</p>'
           + '<h3>Design and Implementation</h3>'
           + '<p>PACT was designed using the following open-source software packages:</p>'
           + '<ul>'
             + '<li><p><b><a href="https://nodejs.org/en/" target="_blank" title="www.nodejs.org">Node</a>:</b> Web server runtime environment</p></li>'
             + '<li><p><b><a href="https://expressjs.com/" target="_blank" title="www.expressjs.com">Express</a>:</b> Web server framework and API</p></li>'
             + '<li><p><b><a href="http://leafletjs.com/" target="_blank" title="www.leafletjs.com">Leaflet</a>:</b> Interactive map framework</p></li>'
             + '<li><p><b><a href="http://geoserver.org/" target="_blank" title="www.geoserver.org">GeoServer</a>:</b> Server for sharing geospatial data</p></li>'
             + '<li><p><b><a href="https://www.postgresql.org/" target="_blank" title="www.postgresql.org">PostgreSQL</a>:</b> Relational database</p></li>'
             + '<li><p><b><a href="http://postgis.net/" target="_blank" title="www.postgis.org">PostGIS</a>:</b> Spatial database extension for PostgreSQL</p></li>'
             + '<li><p><b><a href="https://www.npmjs.com/package/pg" target="_blank" title="www.npmjs.com/package/pg">Node-postgres</a>:</b> Javascript PostgreSQL client for node</p></li>'
             + '<li><p><b><a href="https://d3js.org/" target="_blank" title="www.d3js.org">D3</a>:</b> Data visualization, mapping and interaction</p></li>'
             //+ '<li><p><b><a href="https://github.com/topojson/topojson" target="_blank" title="www.github.com/topojson/topojson">Topojson</a>:</b> Geospatial data format</p></li>'
             //+ '<li><p><b><a href="https://square.github.io/crossfilter/" target="_blank" title="www.square.io/crossfilter">Crossfilter.js</a>:</b> Analytics engine</p></li>'
             + '<li><p><b><a href="https://github.com/d3/d3-queue" target="_blank" title="www.github.com/d3/d3-queue">Queue</a>:</b> Asynchronous dataset and file retrieval</p></li>'
             + '<li><p><b><a href="http://getbootstrap.com/" target="_blank" title="www.getbootstrap.com">Bootstrap</a>:</b> Front-end framework and styling</p></li>'
             //+ '<li><p><b><a href="http://colorbrewer2.org/" target="_blank" title="www.colorbrewer2.org">ColorBrewer</a>:</b> Pre-defined color palettes</p></li>'
           + '</ul>'
           + '<h3>Future Work and Contact Info</h3>'
           + '<p>Development of PACT is currently ongoing and future updates will include range and species expansion, and treatment type (e.g. mowing and burning). If you have any questions, encounter any errors, or are interested in applying PACT to your region, please contact Jason Coombs at <a href="mailto:jcoombs@cns.umass.edu" title="jcoombs@cns.umass.edu">jcoombs@cns.umass.edu</a>.</p>'
           + '<h3>Tool Version</h3>'
           + '<p>v1.1.0 - 05-17-2019</p>'
           + '<ul><li><p>Inclusion of residual basal area and time since treatment occupancy probabilities</p></li></ul>'
           + '<p>v1.0.0 - 12-12-2017</p>'
           + '<ul><li><p>Initial release</p></li></ul>'
         );

      d3.select("#helpContent")
        .append("div")
        .attr("class", "helpDivs")
        .attr("id", "help-videos")
        .html('<h3 style="margin-top:5px;"><i>Coming soon...</i></h3>'
           //+ '<h3>Tool Overview</h3>'
           //+ '<video id="video1" class="video-js vjs-default-skin" controls preload="auto" poster="images/sce_overview.jpg" data-setup="{}"><source src="video/sce_overview.mp4" type="video/mp4"><p class="vjs-no-js">To view this video please enable JavaScript, and consider upgrading to a web browser that <a href="http://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a></p></video>'
           //+ '<h3>Filters and Spatial Joins</h3>'
           //+ '<video id="video2" class="video-js vjs-default-skin" controls preload="auto" poster="images/sce_filtering.jpg" data-setup="{}"><source src="video/sce_filtering.mp4" type="video/mp4"><p class="vjs-no-js">To view this video please enable JavaScript, and consider upgrading to a web browser that <a href="http://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a></p></video>'
           //+ '<h3>Case Study Example</h3>'
           //+ '<video id="video3" class="video-js vjs-default-skin" controls preload="auto" poster="images/sce_scenario.jpg" data-setup="{}"><source src="video/sce_scenario.mp4" type="video/mp4"><p class="vjs-no-js">To view this video please enable JavaScript, and consider upgrading to a web browser that <a href="http://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a></p></video>'
         );       

      d3.select("#helpContent")
        .append("div")
        .attr("class", "helpDivs")
        .attr("id", "help-sources")
        .html('<h3 style="margin-top:5px;">Species Pool</h3>'
          + '<p>We included both obligate and facultative shrubland bird species as identified by <a href="data/schlossberg_and_king_2007.pdf" target="_blank" title="Schlossberg, S.R., and King, D.I. (2007) Ecology and management of scrub-shrub birds in New England: A comprehensive review. Report submitted to Natural Resources Conservation Service, Resource Inventory and Assessment Division, Beltsville, Maryland, USA.">Schlossberg and King (2007)</a>.</p>'
          + '<h3>Regional Occupancy</h3>'
          + '<p>Probabilities are acquired from species specific rasters developed by either Steve Matthews or Jon Atwood and <a href="https://www.massaudubon.org/" target="_blank" title="www.massaudubon.org">Mass Audubon</a>. Values are calculated as the mean value of all pixels that intersect the management opening.</p>'
          + '<h3>Habitat Occupancy</h3>'
          + '<p>Shrubland birds are influenced by <b>opening area</b> (<a href="https://wildlife.onlinelibrary.wiley.com/doi/full/10.1002/jwmg.21286" target="_blank" title="Roberts, H.P. and King, D.I. (2017) Area requirements and landscape-level factors influencing shrubland birds. Journal of Wildlife Management, 81(7):1298-1307.">Roberts and King 2017</a>), <b>residual basal area</b> of trees in the stand (<a href="https://www.sciencedirect.com/science/article/pii/S037811279900167X" target="_blank" title="King, D.I. and DeGraaf, R.M. (2000) Bird species diversity and nesting success in mature, clearcut and shelterwood forest in northern New Hampshire, USA. Forest Ecology and Management, 129(1-3):227-235.">King and DeGraaf 2000</a>), and <b>time since treatment</b> (<a href="https://wildlife.onlinelibrary.wiley.com/doi/abs/10.2193/2007-518" target="_blank" title="Schlossberg, S. and King, D.I. (2009) Postlogging succession and habitat usage of shrubland birds. Journal of Wildlife Management, 73(2):226-231.">Schlossberg and King 2009</a>). In PACT, habitat occupancy probabilities are calculated by the following function, multiplying three separate occupancy probabilities per species:</p>'
          + '<p style="text-align:center;"><b>Habitat occupancy = opening area * basal area * time since treatment</b></p>'
          + '<p>Calculations for each of these three separate occupancy probabilities are detailed below.</p>'
          + '<br>'
          + '<h4><u>Opening Area</u></h4>'
          + '<p>Probabilities for 7 species (Black-and-white Warbler, Chestnut-sided Warbler, Common Yellowthroat, Eastern Towhee, Gray Catbird, Indigo Bunting, and Prairie Warbler) are calculated using equations derived from data on empirical abundance-opening area relationships in <a href="https://wildlife.onlinelibrary.wiley.com/doi/full/10.1002/jwmg.21286" target="_blank" title="Roberts, H.P. and King, D.I. (2017) Area requirements and landscape-level factors influencing shrubland birds. Journal of Wildlife Management, 81(7):1298-1307.">Roberts and King (2017)</a> (Figure 2).' 
            + '<img src="images/roberts_king_fig_2.jpg">'
            + 'One species, the Prairie Warbler, is also influenced by the nearby presence of large openings (<a href="https://wildlife.onlinelibrary.wiley.com/doi/full/10.1002/jwmg.21286" target="_blank" title="Roberts, H.P. and King, D.I. (2017) Area requirements and landscape-level factors influencing shrubland birds. Journal of Wildlife Management, 81(7):1298-1307.">Roberts and King 2017</a>). If a large opening (clearcut \> 5 ha or powerline corridor \> 50 m wide) is specified to be present within 3 km of the management opening, the Prairie Warbler opening area occupancy probability is adjusted accordingly (Figure 3).'
            + '<img src="images/roberts_king_fig_3.jpg">'
          + 'The remaining 15 species are classified into area-sensitivity groups based on data from the published literature and professional judgement, and assigned an occupancy probability function from the most similar species in <a href="https://wildlife.onlinelibrary.wiley.com/doi/full/10.1002/jwmg.21286" target="_blank" title="Roberts, H.P. and King, D.I. (2017) Area requirements and landscape-level factors influencing shrubland birds. Journal of Wildlife Management, 81(7):1298-1307.">Roberts and King (2017)</a> (Figure 2).'
          + '<ul>'
            + '<li>Five species are area-sensitive and assigned the function for Prairie Warblers, the most area-sensitive species:</li>'
            + '<ul>' 
              + '<li>Alder Flycatcher, Field Sparrow, and White-eyed Vireo (<a href="data/schlossberg_and_king_2007.pdf" target="_blank" title="Schlossberg, S.R., and King, D.I. (2007) Ecology and management of scrub-shrub birds in New England: A comprehensive review. Report submitted to Natural Resources Conservation Service, Resource Inventory and Assessment Division, Beltsville, Maryland, USA.">Schlossberg and King 2007</a>).</li>'
              + '<li>Golden-winged Warbler (<a href="https://doi.org/10.1007/978-1-4757-9912-5_1" target="_blank" title="Askins R.A. (1993) Population Trends in Grassland, Shrubland, and Forest Birds in Eastern North America. In: Power D.M. (eds) Current Ornithology. Current Ornithology, vol 11. Springer, Boston, MA">Askins 1993</a>).</li>'
              + '<li>Brown Thrasher (professional judgement (King)).</li>'
            + '</ul>'
            + '<li>Four species show higher affinities for clearcuts compared to group cuts, however each species exhibits a different level of association (<a href="data/schlossberg_and_king_2007.pdf" target="_blank" title="Schlossberg, S.R., and King, D.I. (2007) Ecology and management of scrub-shrub birds in New England: A comprehensive review. Report submitted to Natural Resources Conservation Service, Resource Inventory and Assessment Division, Beltsville, Maryland, USA.">Schlossberg and King 2007</a>, King, unpublished):</li>'
            + '<ul>'
              + '<li>White-throated Sparrow are 19X greater in clearcuts and are assigned the Indigo Bunting function.</li>'
              + '<li>Dark-eyed Junco are 8.5X greater in clearcuts and are assigned the Gray Catbird function.</li>'
              + '<li>Mourning Warbler are 2X greater, and Cedar Waxwing are 1.4X greater in clearcuts and are both assigned the Common Yellowthroat function.</li>'
            + '</ul>'
            + '<li>Six species are not area-sensitive and are assigned an occupancy probability of 1 regardless of the opening area size:</li>'
            + '<ul>'
              + '<li>American Goldfinch (<a href="https://bioone.org/journals/The-Wilson-Journal-of-Ornithology/volume-119/issue-3/04-034.1/SEASONAL-FOREST-PATCH-USE-BY-BIRDS-IN-FRAGMENTED-LANDSCAPES-OF/10.1676/04-034.1.full" target="_blank" title="Keller, G.S. and Yahner, R.H. (2007) Seasonal forest-patch use by birds in fragmented landscapes of south-central Pennsylvania. Wilson Journal of Ornithology, 119(3):410-418.">Keller and Yahner 2007</a>)</li>'
              + '<li>Blue-winged Warbler (<a href="https://doi.org/10.1016/j.foreco.2007.05.009" target="_blank" title="Askins, R.A., Zuckerberg, B., and Novak, L. (2007) Do the size and landscape context of forest openings influence the abundance and breeding success of shrubland songbirds in southern New England?, Forest Ecology and Management, 250(3):137-147.">Askins et al 2007</a>)</li>'
              + '<li>Canada Warbler (no data)</li>'
              + '<li>Nashville Warbler (no data)</li>'
              + '<li>Song Sparrow (<a href="https://bioone.org/journals/The-Wilson-Journal-of-Ornithology/volume-119/issue-3/04-034.1/SEASONAL-FOREST-PATCH-USE-BY-BIRDS-IN-FRAGMENTED-LANDSCAPES-OF/10.1676/04-034.1.full" target="_blank" title="Keller, G.S. and Yahner, R.H. (2007) Seasonal forest-patch use by birds in fragmented landscapes of south-central Pennsylvania. Wilson Journal of Ornithology, 119(3):410-418.">Keller and Yahner 2007</a>)</li>'
              + '<li>Yellow-billed Cuckoo (no data)</li>'
            + '</ul>'
          + '</ul>'
          + '<br>'
          + '<br>'
          + '<h4><u>Residual Basal Area</u></h4>'
          + '<p>We generated functions for the relationship between basal area and tree retention on shrubland bird abundance using a meta-analysis of published studies (Akresh et al in prep). To determine the relationship, we compared three models for each species:</p>'
          + '<ul>'
            + '<li>A null model depicting constant density (without a predictor variable)</li>'
            + '<li>A model with a linear predictor of tree retention</li>'
            + '<li>A model with a quadratic and linear predictor of tree retention</li>'
          + '</ul>'
          + '<p>The parameters from the best-supported model for each species are used by PACT to calculate occupancy probability for residual basal area. However, due to insufficient data, the parameters from a comparable species were used for the following species:</p>'
          + '<ul>'
            + '<li>Brown Thrasher are assigned the Gray Catbird function based on <a href="data/Cade_1986.pdf" target="_blank" title="Cade, B.S. (1986) Habitat suitability index models: Brown thrasher. US Fish and Wildlife Service, Biological Report 82(10.118).">Cade (1986)</a></li>'
            + '<li><img src="images/grca_ba.jpg" style="width:150px;margin:0;"></li>'
            + '<li>Golden-winged Warbler are assigned the Common Yellowthroat function based on <a href="https://www.ace-eco.org/vol13/iss1/art22/" target="_blank" title="McNeil, D.J., Fiss, C.J., Wood, E.M., Duchamp, J.E., Bakermans, M., and Larkin, J.L. (2018) Using a natural reference system to evaluate songbird habitat restoration. Avian Conservation and Ecology, 13(1):Article 22.">McNeil et al (2018)</a></li>'
            + '<li><img src="images/coye_ba.jpg" style="width:150px;margin:0;"></li>'
          + '</ul>'
          + '<p>For the meta-analysis, we quantified the relationship between basal area and perenctage forest retained:</p>'
          + '<p style="text-align:center;"><img src="images/BA_PFR_plot.jpg" style="width:350px;margin:0;margin-left:-100px"></p>'
          + '<p>In PACT, basal area may be entered as square meters/hectare (M^2/HA), square feet/acre (FT^2/AC), or percent forest (% Forest). Changing the measurement unit in PACT automatically converts the existing value to the new selection. Based on the above relationship, basal area measurements greater than or equal to 26.239 M^2/HA or 114.297 FT^2/AC will be converted to 100% forest.</p>'
          + '<p>If managers want to specifically harvest stands with shelterwood or selective logging, the below table contains the recommended residual basal area values for those treatments for a given forest type. <b>NOTE</b>: Recommendations are in <u>square feet/acre</u></p>'
          + '<table id="baTable">'
            + '<thead>'
              + '<th>Forest Type</th>'
              + '<th>Shelterwood</th>'
              + '<th>Single-tree &<br> Group Selection</th>'
              + '<th>Sources</th>'
            + '</thead>'
            + '<tr>'
              + '<td>Northern hardwoods</td>'
              + '<td>30-80</td>'
              + '<td>60-80</td>'
              + '<td><a target="_blank" href="data/leak_et_al_2014.pdf" title="Leak, W.B., Yamasaki, M., and Holleran, R. (2014) Silvicultural guide for northern hardwoods in the northeast. General Technical Report NRS-132. Newtown Square, PA, U.S. Department of Agriculture, Forest Service, Northern Research Station, 46 pp.">Leak et al 2014</a></td>'
            + '</tr>'
            + '<tr>'
              + '<td>Oak-hickory (Central hardwoods)</td>'
              + '<td>60-90</td>'
              + '<td>Not recommended</td>'
              + '<td><a target="_blank" href="data/gingrich_1971.pdf" title="Gingrich, S.F. (1971) Stocking, growth, and yield of oak stands. In: Oak Symposium Proceedings, August 16-20, Upper Darby, PA, U.S. Department of Agriculture, Forest Service, Northeastern Forest Experimental Station. , 65-73.">Gingrich 1971</a><br><a target="_blank" href="https://www.fs.usda.gov/treesearch/pubs/38183" title="Johnson, P.S., Shifley, S.R., and Rogers, R. (2011) The ecology and silviculture of oaks. 2nd Edition. CABI International, Cambridge, MA. 580 p.">Johnson et al 2011</a></td>'
            + '</tr>'
            + '<tr>'
              + '<td>Northern hardwoods/Mixed woods<br>(Hardwoods & conifers)</td>'
              + '<td>30-80</td>'
              + '<td>100-110</td>'
              + '<td><a target="_blank" href="data/leak_et_al_2014.pdf" title="Leak, W.B., Yamasaki, M., and Holleran, R. (2014) Silvicultural guide for northern hardwoods in the northeast. General Technical Report NRS-132. Newtown Square, PA, U.S. Department of Agriculture, Forest Service, Northern Research Station, 46 pp.">Leak et al 2014</a></td>'
            + '</tr>'
            + '<tr>'
              + '<td>White pine</td>'
              + '<td>50-80</td>'
              + '<td>Not recommended</td>'
              + '<td><a target="_blank" href="" title="Lancaster, K.F. (1984) White pine management, a quick review. General Technical Report NA-FR-27. Broomall, PA: U.S. Department of Agriculture, Forest Service, Northeastern Area State and Private Forestry.">Lancaster 1984</a><br><a target="_blank" href="data/leak_and_lamson_1999.pdf" title="Leak, W.B., and Lamson, N.I. (1999) Revised white pine stocking guide for managed stands. NA-TP-01-99. U.S. Department of Agriculture, Forest Service, Northeastern Area State and Private Forestry, 2 pp.">Leak and Lamson 1999</a></td>'
            + '</tr>'
            + '<tr>'
              + '<td>Pitch pine</td>'
              + '<td>20-50</td>'
              + '<td>Not recommended</td>'
              + '<td><a target="_blank" href="data/njpc_2006.pdf" title="New Jersey Pinelands Commission (2006) Recommended forestry management practices report. State of New Jersery, 79 pp.">NJPC 2006</a></td>'
            + '</tr>'
          + '</table>'
          + '<br>'
          + '<br>'
          + '<h4><u>Time Since Treatment</u></h4>'
          + '<p>We quantified relationships in temporal changes in shrubland bird abundance following silvicultural harvests using data collected from and reviewed in <a href="https://wildlife.onlinelibrary.wiley.com/doi/abs/10.2193/2007-518" target="_blank" title="Schlossberg, S. and King, D.I. (2009) Postlogging succession and habitat usage of shrubland birds. Journal of Wildlife Management, 73(2):226-231.">Schlossberg and King (2009)</a>, and data from <a href="https://wildlife.onlinelibrary.wiley.com/doi/full/10.1002/jwmg.658" target="_blank" title="Smetzer, J.R., King, D.I., and Schlossberg, S. (2014) Management regime influences shrubland birds and habitat conditions in the Northern Appalachians, USA. Journal of Wildlife Management, 78(2):314-324.">Smetzer et al (2014)</a>.'
          + '<p>To determine the relationship, we compared three models for each species:</p>'
          + '<ul>'
            + '<li>A null model depicting no change in abundance over year since treatment</li>'
            + '<li>A model with a linear predictor of year since treatment</li>'
            + '<li>A model with a quadratic and linear predictor of year since treatment</li>'
          + '</ul>'
          + '<p>The parameters from the best-supported model for each species are used by PACT to calculate occupancy probabily for time since treatment. However, due to insufficient data we use alternative approaches for the following species:</p>'
          + '<ul>'
            + '<li>American Goldfinch, Blue-winged Warbler, and Brown Thrasher</li>'
            + '<ul>'
              + '<li>Are all obligate shrubland birds, so are assumed to be absent from sites at 0 and \>20 years since harvest and are assigned the Chestnut-sided Warbler function</li>'
              + '<li><img src="images/cswa_tst.jpg" style="width:150px;margin:0;"></li>'
            + '</ul>'
            //+ '<li>Magnolia Warbler</li>'
            //+ '<ul>'
            //  + '<li>Are more abundant in harvested areas than in forest (<a href="data/schlossberg_and_king_2007.pdf" target="_blank" title="Schlossberg, S.R., and King, D.I. (2007) Ecology and management of scrub-shrub birds in New England: A comprehensive review. Report submitted to Natural Resources Conservation Service, Resource Inventory and Assessment Division, Beltsville, Maryland, USA.">Schlossberg and King 2007</a>), yet still present in forest (<a href="https://www.sciencedirect.com/science/article/pii/S037811279900167X" target="_blank" title="King, D.I. and DeGraaf, R.M. (2000) Bird species diversity and nesting success in mature, clearcut and shelterwood forest in northern New Hampshire, USA. Forest Ecology and Management, 129(1-3):227-235.">King and DeGraaf 2000</a>, Akresh unpublished), so are assigned ???</li>'
            //+ '</ul>'
            + '<li>White-eyed Vireo</li>'
            + '<ul>'
              + '<li>Are assigned the Common Yellowthroat function based on results from <a href="https://www.sciencedirect.com/science/article/pii/S0378112713004684" target="_blank" title="Perry, R.W. and Thill, R.E. (2013) Long-term responses of disturbance-associated birds after different timber harvests. Forest Ecology and Management, 307:274-283.">Perry and Thill (2013)</a> and <a href="https://wildlife.onlinelibrary.wiley.com/doi/abs/10.2193/2008-441" target="_blank" title="Twedt, D.J. and Somershoe, S.G. (2009) Bird response to prescribed silvicultural treatments in bottomland hardwood forests. Journal of Wildlife Management, 73(7):1140-1150.">Twedt and Somershoe (2009)</a></li>'
              + '<li><img src="images/coye_tst.jpg" style="width:150px;margin:0;"></li>'
            + '</ul>'
            + '<li>Yellow-billed Cuckoo</li>'
            + '<ul>'
              + '<li>Are deemed not sensitive to time since treatment (<a href="https://www.sciencedirect.com/science/article/pii/S0378112717314810" target="_blank" title="Perry, R.W., Jenkins, J.M.A., Thill, R.E., and Thompson III, F.R. (2018) Long-term effects of different forest regeneration methods on mature forest birds. Forest Ecology and Management, 408:183-194.">Perry et al 2018</a>), and are assigned an occupancy probability of 1</li>'
            + '</ul>'
          + '</ul>'
          + '<h3>Local Occupancy</h3>'
          + '<p>Calculated as the product of regional occupancy and habitat occupancy probabilities.</p>'
          + '<h3>Partners In Flight Score</h3>'
          + '<p>The Regional Concern Score (breeding season) (RCS-b) value from the Partners In Flight <a href="http://pif.birdconservancy.org/ACAD/Database.aspx" target="_blank" title="pif.birdconservancy.org/ACAD/Database.aspx">database</a> is retreived for each species. Values are dependent on the <a href="http://nabci-us.org/resources/bird-conservation-regions-map/" target="_blank" title="nabci-us.org/resources/bird-conservation-regions-map">Bird Conservation Region</a> (BCR) in which the management opening occurs. For openings overlapping multiple regions, values are taken from the region covering the greatest proportion of the opening. An empty cell indicates that there is no RCS-b score for that species in that BCR.</p>'
          + '<h3>Conservation Value</h3>'
          + '<p>The product of the local occupancy and Partners In Flight score for each species summed over all species. The formula is based on a modification to equation 1 in <a href="https://academic.oup.com/auk/article/120/2/541/5147889" target="_blank" title="Nuttle, T., Leidolf, A., and Burger Jr., L.W. (2003) Assessing conservation value of bird communities with Partners In Flight-based ranks. The Auk 120(2):541-549.">Nuttle et al (2003)</a> in which species occupancy probability is substituted for abundance (<i>a<sub>i</sub></i>)</p>'
          + '<div style="text-align:center;"><img src="images/nuttle_equ_1.PNG" style="width:initial;"></div>'
          + '<h3>Likely Number of Species</h3>'
          + '<p>The total number of species present in the management opening that have a local occupancy probability equal to or greater than 0.5.</p>'
        );       


      d3.select("#infoDiv")
        .append("div")
        .attr("id", "helpFunding")
        .html(''
          + '<div id="fundingLeftImg">'
            + '<a href="https://www.fs.fed.us/" target="_blank" class="a_flex">'
              + '<img id="usfs" src="images/shield_color.png" title="U.S. Forest Service"></a>'
            + '</a>'
            + '<a href="https://www.umass.edu/" target="_blank">'
              + '<img id="umass" src="images/umass_amherst.png" title="University of Massachusetts, Amherst">'
            + '</a>'
            + '<a href="https://www.nfwf.org/" target="_blank" class="a_flex">'
              + '<img id="nfwf" src="images/nfwf.png" title="National Fish and Wildlife Foundation">'
            + '</a>'
          + '</div>'
          + '<div id="fundingRightImg">'
            + '<a href="https://www.nrcs.usda.gov/" target="_blank" class="a_flex">'
              + '<img id="nrcs" src="images/NRCS.png" title="Natural Resources Conservation Service">'
            + '</a>'
            + '<a href="https://www.massaudubon.org/" target="_blank">'
              + '<img id="massAudubon" src="images/mass_audubon.png" title="Mass Audubon">'
            + '</a>'
            + '<a href="https://www.antioch.edu/new-england/" target="_blank" class="a_flex">'
              + '<img id="antioch" src="images/antioch.png" title="Antioch University - New England">'
            + '</a>'
          + '</div>'
          + '<p class="fundersP">This project was funded by the <a href="https://www.nfwf.org" target="_blank" title="www.nfwf.org" target="_blank">National Fish and Wildlife Foundation</a> and the <a href="https://www.nrcs.usda.gov/" target="_blank" title="www.nrcs.usda.gov" target="_blank">Natural Resources Conservation Service</a>.</p><p class="fundersP">Additional support was provided by the <a href="https://www.fs.fed.us/" title="www.fs.fed.us" target="_blank">U.S. Forest Service</a>,<br>and the <a href="https://www.umass.edu/" title="www.umass.edu" target="_blank">University of Massachusetts, Amherst</a>.</p>'
        );


      function changePill(tmpID) {
        d3.select("#helpMenu").selectAll("li").classed("active", false);
        d3.select(tmpID).classed("active", true);
        d3.selectAll(".helpDivs").style("display", "none");
        d3.select("#help-" + tmpID.id).style("display", "inline-block");
      }


/*
      d3.select("#infoDiv")
        .append("div")
        .attr("id", "infoDivContent")
        .style("padding", "5px")
        .append("p")
        .html('Local occupancy probabilities were calculated using model results from <a href="https://wildlife.onlinelibrary.wiley.com/doi/full/10.1002/jwmg.21286" target="_blank">Roberts & King, 2017</a> (Figures 2 & 3 below)'
          + '<img src="images/roberts_king_fig_2.jpg">'
          + '<img src="images/roberts_king_fig_3.jpg">'
        );
*/



      //******Make analysis waiting div
      d3.select("body")
        .append("div")
        .attr("id", "waitingDiv")
        .html('<img src="images/animated-gears.gif"></img><h3>Processing</h3>');



      //******Make tooltip for displaying attribute data
      var tooltip = d3.select("body")
        .append("div")
        .attr("id", "d3Tooltip")
        .attr("class", "d3Tooltip");



      //*******Show slider values
      function showIt(tmpSlider) {
        tooltip.html(function() { return parseFloat(d3.select(tmpSlider).property("value")).toFixed(3); });
        tooltip.style("visibility", "visible");
      }



      //******Download external data files
      var birds = {}; //global birds variable
      birds.basal = {};
      birds.succession = {};
      birds.occ = {};
      graphSpp = [];  //global list of species that have their occupancy graphs displayed
      var queryType = "";  //global query type (stats or point)
      var queryCentroid = [];  //global centroid point for point query if pixel count of opening is zero
      var queryRID = [];    //global raster ID variable to speed occupancy queries
      var queryBCR = "";   //global BCR id variable
      var queryPIF = [];   //global PIF data
      var layerID = "";   //global variable containing the id of the management opening layer

      queue()
        .defer(d3.tsv, 'bird_media.tsv')
        .await(loadData);

      //******Load external data into JSON
      function loadData(error, mediaData) {
        birds.keys = d3.keys(mediaData[0]);
        birds.latin = {};
        
        birds.media = mediaData.map(function(d) {
          var tmpJSON = {};
          var tmpVals = d3.values(d);
          tmpVals.forEach(function(val,i) {
            tmpJSON[birds.keys[i]] = d[birds.keys[i]];
          });
          return tmpJSON;
        });

        birds.media = birds.media.filter(function(d) { return birdTitles.indexOf(d.common) > -1; });

        birds.media.forEach(function(d) { birds.latin[d.id] = d.latin; });

        //******Add selection to change bird media
        var select = d3.select("#songs")
          .append("select")
          .attr("id", "songSelect")
          .attr("class", "shapeUnit")
          .style("width", "188px")
          .property("title", "Select species to hear its song and display a photo")
          .on("change", function() { changeSpecies(this); });

        select.selectAll("option")
          .data(birds.media)
          .enter()
            .append("option")
              .attr("value", function(d) { return d.id; })
              .attr("data-spp", function(d,i) { return birdID[i]; })
              .property("title", function(d,i) { return d.common + " (" + birds.latin[d.id] + ")"; })
              .text(function(d) { return d.common; });

        //***Add exclusivity with other leaflet draw variable
        d3.select("#drawToolbar").select(".leaflet-draw").selectAll("a").on("click", function() {
          measureDrawControl._toolbars.draw.disable();
          /*measureDrawControl._toolbars.edit.disable();*/
        });

        var tmpTitles = ["Measure distance", "Measure area (polygon)", "Measure area (rectangle)"];
        d3.select("#measureTool").select(".leaflet-draw").selectAll("a")
          .property("title", function(d,i) { return tmpTitles[i]; })
          .on("click", function() { drawControl._toolbars.draw.disable(); drawControl._toolbars.edit.disable(); });

        d3.select("#measureMetricDiv").classed("inactive", true);

        //******Run splash and intro for first time users
        d3.select("#disableSplash").property("checked", function() { if(localStorage.getItem('disableSplash') == "true") { return true; } else { return false; } });
        if(localStorage.getItem('disableSplash') != "true") {
          d3.select("#splashScreen").style("display","flex");
        }

        toolWindowToggle("draw");

        //***Check to see if browser is firefox, and if so adjust table height
        if(typeof InstallTrigger !== 'undefined') { d3.select("#resultsTableBody").style("height", "412px"); }
      }


      //******Change the species picture and song
      function changeSpecies(tmpSpp) {
        d3.select("#sppCommon")
          .text(d3.select("#songSelect").selectAll("option")[0][d3.select("#songSelect").property("selectedIndex")].text)
          .property("title", d3.select("#songSelect").selectAll("option")[0][d3.select("#songSelect").property("selectedIndex")].text);
        d3.select("#sppLatin")
          .text(birds.latin[tmpSpp.value])
          .property("title", birds.latin[tmpSpp.value]);
        d3.select("#birdPic")
          .attr("src", "bird_pics/" + tmpSpp.value + ".jpg")
          .property("title", d3.select("#songSelect").selectAll("option")[0][d3.select("#songSelect").property("selectedIndex")].text);
        d3.select("#birdSong").attr("src", "bird_songs/" + tmpSpp.value + ".mp3");
        d3.select("#birdSong")[0][0].play();
      }


      //******Set z-indexes of moveable divs so that clicked one is always on top
      d3.selectAll("#legendDiv,#drawDiv,#exportDiv,#resultsDiv,#songsDiv,#downloadDiv,#graphsDiv")
        .on("mousedown", function() { setZ(this); });

    </script>
  </body>
</html>